<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ“ Grammatik Quest - Det Ultimata Ordklassspelet!</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Grammatik Quest">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667eea' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3EðŸŽ“%3C/text%3E%3C/svg%3E">
    
    <!-- Dosis Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .game-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
            position: relative;
            z-index: 1;
            animation: containerFadeIn 0.8s ease-out;
        }

        @keyframes containerFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        .game-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: headerShine 3s infinite;
        }

        @keyframes headerShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .game-header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.25);
            padding: 18px;
            border-radius: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .stat {
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            animation: statPulse 2s ease-in-out infinite;
            color: white;
        }

        @keyframes statPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* XP Bar */
        .xp-bar-container {
            margin-top: 15px;
        }

        .xp-bar-label {
            text-align: center;
            font-size: 0.9em;
            color: white;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .xp-bar-bg {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            height: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .xp-bar-fill {
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease-out;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .game-content {
            padding: 30px;
        }

        .question-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            animation: cardSlideIn 0.5s ease-out;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .question-card:hover::before {
            left: 100%;
        }

        .question-text {
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #333;
            font-weight: 600;
            position: relative;
            z-index: 1;
            line-height: 1.5;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .options:has(.write-answer-container) {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .study-hint {
            text-align: center;
            margin-top: 20px;
            padding: 12px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            color: #667eea;
            font-size: 0.95em;
            font-weight: 500;
            border: 2px dashed rgba(102, 126, 234, 0.3);
            position: relative;
            z-index: 1;
            transition: all 0.4s ease-out;
        }

        .study-hint strong {
            color: #764ba2;
            font-weight: 700;
        }

        .option-btn {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 18px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 600;
            color: #333;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .option-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .option-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .option-btn:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .option-btn:active {
            transform: translateY(-2px) scale(0.98);
        }

        .option-btn.correct {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
            animation: correctPulse 0.6s ease-out;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
        }

        .option-btn.wrong {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border-color: #f44336;
            animation: shake 0.6s ease-out;
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.6);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            25% { transform: scale(1.08); }
            50% { transform: scale(0.98); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translateX(10px) rotate(2deg); }
        }

        .powerups {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .powerup-btn {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(252, 182, 159, 0.3);
            position: relative;
            overflow: hidden;
        }

        .study-btn {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(132, 250, 176, 0.3);
            position: relative;
            overflow: hidden;
        }

        .study-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .study-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .study-btn:hover {
            transform: scale(1.15) translateY(-3px);
            box-shadow: 0 8px 25px rgba(132, 250, 176, 0.5);
        }

        .study-btn:active {
            transform: scale(1.05) translateY(-1px);
        }

        .sound-toggle {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(255, 234, 167, 0.3);
            position: relative;
            overflow: hidden;
        }

        .sound-toggle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .sound-toggle:hover::before {
            width: 300px;
            height: 300px;
        }

        .sound-toggle:hover {
            transform: scale(1.15) translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 234, 167, 0.5);
        }

        .sound-toggle:active {
            transform: scale(1.05) translateY(-1px);
        }

        .stats-btn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(168, 237, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .stats-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .stats-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .stats-btn:hover {
            transform: scale(1.15) translateY(-3px);
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.5);
        }

        .stats-btn:active {
            transform: scale(1.05) translateY(-1px);
        }

        .theme-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .theme-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .theme-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .theme-btn:hover {
            transform: scale(1.15) translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .theme-btn:active {
            transform: scale(1.05) translateY(-1px);
        }

        .stats-open-btn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #667eea;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .stats-open-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .stats-open-btn:hover::before {
            width: 600px;
            height: 600px;
        }

        .stats-open-btn:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 35px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .stats-open-btn:active {
            transform: scale(1.02) translateY(-2px);
        }

        /* Game Mode Selector */
        .game-mode-selector {
            padding: 30px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .game-mode-selector h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 30px;
            animation: titleBounce 0.6s ease-out;
        }

        @keyframes titleBounce {
            0% { transform: translateY(-30px); opacity: 0; }
            60% { transform: translateY(10px); }
            100% { transform: translateY(0); opacity: 1; }
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .mode-btn {
            background: white;
            border: 3px solid #667eea;
            border-radius: 20px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            animation: modeCardSlideIn 0.6s ease-out backwards;
        }

        .mode-btn:nth-child(1) { animation-delay: 0.1s; }
        .mode-btn:nth-child(2) { animation-delay: 0.2s; }
        .mode-btn:nth-child(3) { animation-delay: 0.3s; }
        .mode-btn:nth-child(4) { animation-delay: 0.4s; }

        @keyframes modeCardSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .mode-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .mode-btn:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
        }

        .mode-btn:hover .mode-icon {
            transform: scale(1.2) rotate(10deg);
        }

        .mode-btn:hover .mode-name,
        .mode-btn:hover .mode-desc {
            color: white;
        }

        .mode-btn:active {
            transform: translateY(-5px) scale(1.02);
        }

        .mode-icon {
            font-size: 4em;
            margin-bottom: 15px;
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .mode-name {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            transition: color 0.3s;
            position: relative;
            z-index: 1;
            font-family: 'Quicksand', sans-serif;
        }

        .mode-desc {
            font-size: 1em;
            color: #666;
            transition: color 0.3s;
            position: relative;
            z-index: 1;
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
        }

        .mode-btn-special {
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6b3 100%);
        }

        .mode-btn-special:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-color: #FFA500;
        }

        .mode-btn-special .mode-name,
        .mode-btn-special .mode-desc {
            color: #b8860b;
        }

        .mode-btn-special:hover .mode-name,
        .mode-btn-special:hover .mode-desc {
            color: white;
        }

        /* Test Mode Button */
        .mode-btn-test {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            border: 3px solid #19547b;
        }

        .mode-btn-test .mode-name,
        .mode-btn-test .mode-desc,
        .mode-btn-test .mode-icon {
            color: white;
        }

        .mode-btn-test:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 60px rgba(25, 84, 123, 0.5);
        }

        /* Online Premium Button */
        .mode-btn-premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px solid #667eea;
            animation: premiumShine 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .mode-btn-premium .mode-name,
        .mode-btn-premium .mode-desc,
        .mode-btn-premium .mode-icon {
            color: white;
            position: relative;
            z-index: 1;
        }

        .mode-btn-premium::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transform: rotate(45deg);
            animation: premiumSlide 3s linear infinite;
        }

        @keyframes premiumSlide {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes premiumShine {
            0%, 100% { box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6); }
        }

        .mode-btn-premium:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.7);
        }

        /* Online Multiplayer Styles */
        .online-setup {
            padding: 20px;
        }

        .online-tabs, .party-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .online-tab, .party-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .online-tab.active, .party-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .online-tab-content, .party-tab-content {
            animation: fadeIn 0.3s ease;
        }

        .players-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            min-height: 60px;
        }

        .spectator-selection {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .spectator-btn {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .spectator-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a3a6 100%);
            color: white;
            border-color: #4ecdc4;
        }

        .spectator-btn:hover {
            transform: translateY(-2px);
        }

        .time-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .time-number-input {
            flex: 1;
            padding: 15px;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            border: 3px solid #667eea;
            border-radius: 15px;
            background: white;
            color: #667eea;
            max-width: 150px;
            transition: all 0.3s ease;
        }

        .time-number-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .time-unit {
            font-weight: 600;
            color: #666;
            font-size: 1.1em;
        }

        .player-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-item.host {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        /* Party Game Area */
        .party-game-wrapper {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            padding: 20px;
            position: relative;
        }

        .party-game-wrapper.spectator-mode {
            grid-template-columns: 1fr;
            justify-items: center;
        }

        .party-game-wrapper.spectator-mode .party-question-container {
            display: none;
        }

        .party-game-wrapper.spectator-mode .party-leaderboard {
            max-width: 600px;
            width: 100%;
            grid-column: 1;
        }

        .party-game-wrapper.spectator-mode .party-my-score {
            display: none;
        }

        .party-top-bar {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            gap: 20px;
        }

        .party-top-bar > * {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .party-top-bar > button {
            flex: 0 0 auto;
        }

        .party-timer {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .party-my-score {
            font-size: 1.5em;
            font-weight: 600;
        }

        .score-big {
            font-size: 2em;
            color: #FFD700;
            font-weight: bold;
        }

        .party-question-container {
            background: white;
            border-radius: 25px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .party-question {
            font-size: 2em;
            text-align: center;
            color: #333;
        }

        .party-feedback {
            min-height: 40px;
            text-align: center;
        }

        .party-leaderboard {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .party-leaderboard h3 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .leaderboard-item.me {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a3a6 100%);
            color: white;
            font-weight: bold;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: bold;
            min-width: 30px;
        }

        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .leaderboard-item.me .leaderboard-score {
            color: white;
        }

        @media (max-width: 768px) {
            .party-game-wrapper {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }

            .party-leaderboard {
                max-height: 200px;
            }
        }

        .lobby-code-display {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .lobby-code-display span {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Countdown Overlay */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .countdown-number {
            font-size: 15em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.8);
            animation: countdownPulse 1s ease-out;
        }

        .countdown-go {
            font-size: 12em;
            font-weight: bold;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: goExplode 0.8s ease-out;
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes goExplode {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.3) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Game Mode Info Bar */
        #game-mode-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mode-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .mode-info-icon {
            font-size: 1.5em;
        }

        #timer {
            font-size: 2em;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: timerPulse 1s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #timer.warning {
            color: #ff4444;
            animation: timerWarning 0.5s ease-in-out infinite;
        }

        @keyframes timerWarning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .lives-display {
            font-size: 2em;
        }

        .lives-container {
            display: flex;
            gap: 15px;
        }

        .heart {
            font-size: 2.5em;
            animation: heartBeat 1.5s ease-in-out infinite;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: inline-block;
        }

        .heart:nth-child(1) {
            animation-delay: 0s;
        }

        .heart:nth-child(2) {
            animation-delay: 0.2s;
        }

        .heart:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes heartBeat {
            0%, 100% {
                transform: scale(1);
            }
            25% {
                transform: scale(1.1);
            }
        }

        .heart-lost {
            animation: heartBreak 0.6s ease-out forwards !important;
        }

        @keyframes heartBreak {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.3) rotate(15deg);
                opacity: 0.7;
            }
            100% {
                transform: scale(0) rotate(45deg) translateY(-50px);
                opacity: 0;
            }
        }

        .change-mode-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 18px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
            position: relative;
            overflow: hidden;
            width: auto;
            display: inline-block;
        }

        .change-mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .change-mode-btn:hover::before {
            width: 500px;
            height: 500px;
        }

        .change-mode-btn:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.5);
        }

        .change-mode-btn:active {
            transform: scale(1.02) translateY(-1px);
        }

        /* Topic Selector */
        .topic-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .topic-select-btn {
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .topic-select-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .topic-select-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .topic-select-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
        }

        .topic-select-btn:hover .topic-select-icon {
            transform: scale(1.3) rotate(15deg);
        }

        .topic-select-btn:hover .topic-select-name {
            color: white;
        }

        .topic-select-icon {
            font-size: 3em;
            margin-bottom: 15px;
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .topic-select-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            transition: color 0.3s;
            position: relative;
            z-index: 1;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 9999;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Particles */
        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: particleExplode 1s ease-out forwards;
        }

        @keyframes particleExplode {
            to {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        /* Results Modal */
        .results-display {
            text-align: center;
            padding: 30px;
        }

        .results-stat {
            font-size: 2em;
            margin: 20px 0;
            color: #667eea;
            animation: resultStatPop 0.5s ease-out backwards;
        }

        .results-stat:nth-child(1) { animation-delay: 0.1s; }
        .results-stat:nth-child(2) { animation-delay: 0.2s; }
        .results-stat:nth-child(3) { animation-delay: 0.3s; }
        .results-stat:nth-child(4) { animation-delay: 0.4s; }

        @keyframes resultStatPop {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .results-record {
            font-size: 1.5em;
            color: #FFD700;
            font-weight: bold;
            margin-top: 20px;
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .results-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .results-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .share-btn {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: installSlideUp 0.5s ease-out;
            max-width: 400px;
            width: 90%;
        }

        @keyframes installSlideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 100px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .install-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 15px;
        }

        .install-icon {
            font-size: 3em;
        }

        .install-text strong {
            color: #667eea;
            font-size: 1.2em;
        }

        .install-text p {
            color: #666;
            margin-top: 5px;
        }

        .install-btn-yes, .install-btn-no {
            padding: 12px 25px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1em;
        }

        .install-btn-yes {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .install-btn-yes:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .install-btn-no {
            background: #f0f0f0;
            color: #666;
            width: 100%;
        }

        .install-btn-no:hover {
            background: #e0e0e0;
        }

        /* Buy Effects */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes buySuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(132, 250, 176, 0.6); }
            100% { transform: scale(1); }
        }

        .buy-error-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            z-index: 10001;
            box-shadow: 0 10px 40px rgba(255, 107, 107, 0.5);
            animation: errorPop 0.5s ease-out;
        }

        @keyframes errorPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .buy-success-msg {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, 0);
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 10001;
            box-shadow: 0 8px 30px rgba(132, 250, 176, 0.4);
            animation: successSlideIn 0.4s ease-out;
            transition: opacity 0.5s, transform 0.5s;
        }

        @keyframes successSlideIn {
            from { transform: translate(-50%, -30px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Confirmation Dialog */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .confirm-dialog {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: confirmDialogIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
        }

        @keyframes confirmDialogIn {
            from {
                transform: scale(0.7) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes confirmDialogOut {
            from {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to {
                transform: scale(0.8) translateY(30px);
                opacity: 0;
            }
        }

        .confirm-dialog h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .confirm-dialog p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Quicksand', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .confirm-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .confirm-btn:active {
            transform: scale(0.98);
        }

        .cancel-btn {
            background: #f0f0f0;
            color: #666;
        }

        .cancel-btn::before {
            background: rgba(0, 0, 0, 0.05);
        }

        .cancel-btn:hover {
            background: #e0e0e0;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .confirm-btn-yes {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .confirm-btn-yes::before {
            background: rgba(255, 255, 255, 0.2);
        }

        .confirm-btn-yes:hover {
            transform: translateY(-5px) scale(1.08);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        }

        /* Write Answer Mode */
        .write-answer-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            padding: 40px 20px;
        }

        .write-answer-input {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            font-size: 1.3em;
            font-family: 'Quicksand', sans-serif;
            border: 3px solid #667eea;
            border-radius: 15px;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
        }

        .write-answer-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
            transform: scale(1.02);
        }

        .write-answer-input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .submit-answer-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .submit-answer-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-answer-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .submit-answer-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .submit-answer-btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .submit-answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 1v1 Mode Styles */
        .vs1v1-setup {
            text-align: center;
            padding: 20px;
        }

        .vs1v1-setup h3 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .time-selection {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .time-btn {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .time-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .player-names {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .player-name-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-name-input label {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
        }

        .player-name-input input {
            padding: 12px 20px;
            border: 3px solid #667eea;
            border-radius: 10px;
            font-size: 1.1em;
            font-family: 'Quicksand', sans-serif;
            text-align: center;
        }

        .vs-divider {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .start-vs-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 50px;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        .start-vs-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.6);
        }

        /* 1v1 UPGRADED DESIGN */
        .vs1v1-wrapper {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            position: relative;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .vs1v1-cancel-btn {
            position: static;
            display: block;
            margin: 0 auto;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 30px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
            overflow: hidden;
            position: relative;
            max-width: 200px;
        }

        .vs1v1-cancel-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .vs1v1-cancel-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .vs1v1-cancel-btn:hover {
            transform: translateY(-5px) scale(1.08);
            box-shadow: 0 12px 35px rgba(245, 87, 108, 0.6);
        }

        .vs1v1-stats-top {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 25px;
            padding: 25px 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            animation: floatIn 0.8s ease-out;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px 30px;
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 220px;
        }

        .player-stat-box:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .player-stat-box:first-child {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a3a6 100%);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }

        .player-stat-box:last-child {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .stat-name {
            color: white;
            font-size: 1.4em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .stat-score {
            font-size: 3em;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            animation: scoreGlow 2s ease-in-out infinite;
        }

        @keyframes scoreGlow {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            }
            50% { 
                transform: scale(1.08);
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 3px 3px 6px rgba(0,0,0,0.3);
            }
        }

        .player-stat-box::after {
            content: 'rÃ¤tt';
            color: white;
            font-size: 1em;
            opacity: 0.9;
            font-weight: 600;
        }

        .vs1v1-timer-bar {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 25px;
            padding: 18px 50px;
            text-align: center;
            max-width: 350px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(255, 165, 0, 0.5);
            animation: timerPulse 1.5s ease-in-out infinite, floatIn 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .vs1v1-timer-bar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes timerPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(255, 165, 0, 0.5);
            }
            50% { 
                transform: scale(1.03);
                box-shadow: 0 15px 50px rgba(255, 165, 0, 0.7);
            }
        }

        .timer-display {
            font-size: 2.8em;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .vs1v1-game-split {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 0;
            border: 4px solid #333;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .vs1v1-side {
            padding: 40px;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 30px;
        }

        .vs-divider {
            width: 100px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            writing-mode: vertical-rl;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }

        .question-box {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
            line-height: 1.6;
            text-align: center;
            min-height: 80px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .vs1v1-question {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
            line-height: 1.6;
        }

        .vs1v1-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vs1v1-option-btn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .vs1v1-option-btn:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .vs1v1-option-btn.correct {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
        }

        .vs1v1-option-btn.wrong {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
            border-color: #f44336;
        }

        .vs1v1-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            writing-mode: vertical-rl;
            animation: vsDividerPulse 2s ease-in-out infinite;
            min-width: 60px;
        }

        @keyframes vsDividerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .vs1v1-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            min-height: 60px;
        }

        #player1Side {
            border-left: 5px solid #4ecdc4;
        }

        #player2Side {
            border-right: 5px solid #ff6b6b;
        }

        .powerup-btn:hover:not(:disabled) {
            transform: scale(1.15) rotate(2deg);
            box-shadow: 0 8px 25px rgba(252, 182, 159, 0.5);
        }

        .powerup-btn:active:not(:disabled) {
            transform: scale(1.05);
        }

        .powerup-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .shop {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: shopSlideIn 0.6s ease-out;
        }

        @keyframes shopSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shop h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .shop-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid #ddd;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .shop-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .shop-item:hover::before {
            left: 100%;
        }

        .shop-item:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .shop-item h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.3em;
            position: relative;
            z-index: 1;
        }

        .shop-item p {
            color: #666;
            margin-bottom: 12px;
            font-size: 0.95em;
            position: relative;
            z-index: 1;
        }

        .shop-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .shop-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5568d3 0%, #653a8c 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .shop-btn:active:not(:disabled) {
            transform: translateY(-1px) scale(1.02);
        }

        .shop-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            transition: all 0.4s ease-out;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            animation: feedbackSlideIn 0.4s ease-out;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
            animation: feedbackSlideIn 0.4s ease-out;
        }

        @keyframes feedbackSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-top: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                max-height: 500px;
                padding-top: 15px;
                padding-bottom: 15px;
                margin-top: 15px;
            }
        }

        @keyframes feedbackSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-15px);
            }
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.5);
            z-index: 10000;
            animation: achievementSlideIn 0.5s ease-out;
            max-width: 300px;
        }

        .achievement-content {
            color: white;
            text-align: center;
        }

        .achievement-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .achievement-desc {
            font-size: 0.9em;
            opacity: 0.95;
        }

        @keyframes achievementSlideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes achievementSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        /* Stats Modal Styles */
        .stats-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 15px;
            color: white;
            animation: statsSectionSlideIn 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .stats-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: statsSectionShine 3s infinite;
        }

        @keyframes statsSectionSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes statsSectionShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .stats-section h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
            position: relative;
            z-index: 1;
        }

        .stat-value-large {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            animation: statValuePulse 2s ease-in-out infinite;
        }

        @keyframes statValuePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: statCardSlideIn 0.6s ease-out backwards;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes statCardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .achievements-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            animation: achievementsTitleSlideIn 0.7s ease-out;
        }

        @keyframes achievementsTitleSlideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .achievement-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid #ddd;
            animation: achievementCardSlideIn 0.6s ease-out backwards;
            position: relative;
            overflow: hidden;
        }

        .achievement-card:nth-child(1) { animation-delay: 0.1s; }
        .achievement-card:nth-child(2) { animation-delay: 0.15s; }
        .achievement-card:nth-child(3) { animation-delay: 0.2s; }
        .achievement-card:nth-child(4) { animation-delay: 0.25s; }
        .achievement-card:nth-child(5) { animation-delay: 0.3s; }
        .achievement-card:nth-child(6) { animation-delay: 0.35s; }
        .achievement-card:nth-child(7) { animation-delay: 0.4s; }
        .achievement-card:nth-child(8) { animation-delay: 0.45s; }
        .achievement-card:nth-child(9) { animation-delay: 0.5s; }
        .achievement-card:nth-child(10) { animation-delay: 0.55s; }

        @keyframes achievementCardSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .achievement-card.unlocked {
            border-color: #FFD700;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .achievement-card.unlocked::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.2), transparent);
            animation: achievementShine 3s infinite;
        }

        @keyframes achievementShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(0.8);
        }

        .achievement-card:hover {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .achievement-card.unlocked:hover {
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.6);
        }

        .achievement-icon {
            font-size: 3em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            animation: achievementIconBounce 2s ease-in-out infinite;
        }

        @keyframes achievementIconBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.1); }
        }

        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            position: relative;
            z-index: 1;
        }

        .achievement-desc {
            font-size: 0.85em;
            color: #666;
            position: relative;
            z-index: 1;
        }

        /* Dark Theme */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-theme .game-container {
            background: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-theme .game-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        body.dark-theme .stats-bar {
            background: rgba(0,0,0,0.3);
        }

        body.dark-theme .question-card {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: #ecf0f1;
        }

        body.dark-theme .option-btn {
            background: #34495e;
            color: #ecf0f1;
            border-color: #667eea;
        }

        body.dark-theme .option-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.dark-theme .shop {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        body.dark-theme .shop h2 {
            color: #84fab0;
        }

        body.dark-theme .shop-item {
            background: #2c3e50;
            border-color: #34495e;
            color: #ecf0f1;
        }

        body.dark-theme .study-hint {
            background: rgba(132, 250, 176, 0.2);
            border-color: rgba(132, 250, 176, 0.4);
            color: #84fab0;
        }

        body.dark-theme .modal-content {
            background: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-theme .modal-body {
            background: #34495e;
        }

        body.dark-theme .topic-btn {
            background: #2c3e50;
            color: #84fab0;
            border-color: #84fab0;
        }

        body.dark-theme .topic-btn:hover {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2c3e50;
        }

        body.dark-theme .topic-btn.active {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2c3e50;
        }

        body.dark-theme .study-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
        }

        body.dark-theme .example-box {
            background: #34495e;
            border-color: #84fab0;
        }

        body.dark-theme .stat-card {
            background: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-theme .stat-label {
            color: #95a5a6;
        }

        body.dark-theme .achievement-card {
            background: #2c3e50;
            border-color: #34495e;
            color: #ecf0f1;
        }

        body.dark-theme .achievement-card.unlocked {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border-color: #FFD700;
        }

        body.dark-theme .achievement-desc {
            color: #95a5a6;
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 18px 50px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 25px auto 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .next-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .next-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .next-btn:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 10px 35px rgba(102, 126, 234, 0.5);
        }

        .next-btn:active {
            transform: scale(1.02) translateY(-1px);
        }

        .streak-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 12px;
            font-weight: bold;
            animation: streakPulse 2s infinite, streakFloat 3s ease-in-out infinite;
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.5);
        }

        @keyframes streakPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes streakFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .level-up {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: bold;
            animation: levelUpAnim 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
            position: relative;
            overflow: hidden;
        }

        .level-up::before {
            content: 'â­';
            position: absolute;
            font-size: 5em;
            opacity: 0.15;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: starSpin 2s linear infinite;
        }

        @keyframes starSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes levelUpAnim {
            0% { 
                transform: scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.15) rotate(10deg); 
            }
            70% {
                transform: scale(0.95) rotate(-5deg);
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        .shimmer-effect {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.6),
                transparent
            );
            animation: shimmerSweep 1s ease-out;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes shimmerSweep {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            overflow-y: auto;
            animation: modalBackdropFadeIn 0.4s ease-out;
        }

        @keyframes modalBackdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalBackdropFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 85%;
            max-width: 750px;
            border-radius: 25px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            animation: modalShine 4s infinite;
        }

        @keyframes modalShine {
            0% { left: -100%; }
            50%, 100% { left: 200%; }
        }

        @keyframes modalSlideIn {
            from { 
                transform: translateY(-100px) scale(0.9); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }

        @keyframes modalSlideOut {
            from { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            to { 
                transform: translateY(50px) scale(0.95); 
                opacity: 0; 
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 30px;
            color: white;
            border-radius: 25px 25px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: headerShine 3s infinite;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 2.2em;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .close-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .close-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: #f44336;
            color: white;
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .close-btn:active {
            transform: rotate(90deg) scale(1.05);
        }

        .modal-body {
            padding: 30px;
            background: white;
        }

        .topic-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .topic-btn {
            background: white;
            color: #667eea;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            position: relative;
            overflow: hidden;
        }

        .topic-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .topic-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .topic-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .topic-btn:active {
            transform: translateY(-1px) scale(1);
        }

        .topic-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }

        .study-content {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 30px;
            line-height: 1.8;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .study-search-container {
            margin: 20px 0;
        }

        .study-search-input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #667eea;
            border-radius: 15px;
            font-size: 1.1em;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        .study-search-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .study-search-input::placeholder {
            color: #999;
        }

        .highlight {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(30px);
            }
            to { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from { 
                opacity: 1; 
                transform: translateX(0);
            }
            to { 
                opacity: 0; 
                transform: translateX(-30px);
            }
        }

        .study-content h3 {
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 12px;
            font-size: 1.5em;
        }

        .study-content h3:first-child {
            margin-top: 0;
        }

        .study-content ul {
            margin-left: 25px;
            margin-bottom: 18px;
        }

        .study-content li {
            margin-bottom: 10px;
        }

        .study-content strong {
            color: #764ba2;
            font-weight: 700;
        }

        .study-content p {
            margin-bottom: 15px;
            color: #333;
        }

        .example-box {
            background: white;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .example-box strong {
            color: #667eea;
        }

        /* Mobile Responsive Design */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .game-container {
                border-radius: 20px;
            }

            .game-header {
                padding: 20px;
            }

            .game-header h1 {
                font-size: 2em;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px;
            }

            .stat {
                flex: 1 1 45%;
                min-width: 100px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .stat-label {
                font-size: 0.85em;
            }

            .game-content {
                padding: 15px;
            }

            .question-card {
                padding: 20px;
                border-radius: 15px;
            }

            .question-text {
                font-size: 1.15em;
                margin-bottom: 20px;
            }

            .options {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .option-btn {
                padding: 15px;
                font-size: 1em;
            }

            .study-hint {
                margin-top: 15px;
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .powerups {
                gap: 8px;
            }

            .powerup-btn, .study-btn, .stats-btn, .theme-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                border-radius: 10px;
            }

            .sound-toggle {
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .stats-open-btn {
                padding: 15px 30px;
                font-size: 1.1em;
            }

            .game-mode-selector h2 {
                font-size: 2em;
            }

            .mode-buttons {
                grid-template-columns: 1fr;
            }

            .mode-btn {
                padding: 25px 15px;
            }

            .mode-icon {
                font-size: 3em;
            }

            #game-mode-info {
                flex-direction: column;
                gap: 10px;
            }

            .topic-selector-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-actions {
                flex-direction: column;
            }

            .results-btn {
                width: 100%;
            }

            .install-prompt {
                max-width: 90%;
                padding: 15px;
            }

            /* 1v1 Mobile */
            .vs1v1-game-split {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto 1fr;
            }

            .vs-divider {
                width: 100%;
                height: 80px;
                writing-mode: horizontal-tb;
            }

            .vs1v1-stats-top {
                flex-direction: column;
                gap: 15px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .player-names {
                flex-direction: column;
            }

            .time-selection {
                flex-wrap: wrap;
            }

            .shop {
                padding: 15px;
                border-radius: 15px;
            }

            .shop h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            .shop-items {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .shop-item {
                padding: 15px;
            }

            .shop-item h3 {
                font-size: 1.1em;
            }

            .next-btn {
                padding: 15px 35px;
                font-size: 1.1em;
            }

            .level-up {
                padding: 20px;
                font-size: 1.5em;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                border-radius: 20px;
            }

            .modal-header {
                padding: 20px;
                border-radius: 20px 20px 0 0;
            }

            .modal-header h2 {
                font-size: 1.8em;
            }

            .close-btn {
                width: 40px;
                height: 40px;
                font-size: 1.5em;
            }

            .modal-body {
                padding: 20px;
            }

            .topic-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .topic-btn {
                padding: 12px;
                font-size: 0.9em;
            }

            .study-content {
                padding: 20px;
                font-size: 0.95em;
            }

            .study-content h3 {
                font-size: 1.3em;
                margin-top: 20px;
            }

            .example-box {
                padding: 15px;
                margin: 15px 0;
            }
        }

        @media screen and (max-width: 480px) {
            .game-header h1 {
                font-size: 1.6em;
            }

            .stats-bar {
                padding: 10px;
            }

            .stat {
                flex: 1 1 100%;
            }

            .stat-value {
                font-size: 1.3em;
            }

            .question-text {
                font-size: 1.05em;
            }

            .powerups {
                flex-direction: column;
                width: 100%;
            }

            .powerup-btn, .study-btn {
                width: 100%;
            }

            .stats-open-btn {
                padding: 12px 25px;
                font-size: 1em;
            }

            .modal-header h2 {
                font-size: 1.5em;
            }

            .topic-buttons {
                grid-template-columns: 1fr;
            }

            .shop-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }

            .achievement-popup {
                right: 10px;
                top: 10px;
                max-width: 250px;
                padding: 15px;
            }

            .achievement-title {
                font-size: 1.1em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .achievements-grid {
                grid-template-columns: 1fr;
            }

            .game-mode-selector h2 {
                font-size: 1.6em;
            }

            .mode-icon {
                font-size: 2.5em;
            }

            .mode-name {
                font-size: 1.2em;
            }

            .topic-selector-grid {
                grid-template-columns: 1fr;
            }

            .topic-select-icon {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>ðŸŽ“ Grammatik Quest</h1>
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-value" id="coins">0</span>
                    <span class="stat-label">ðŸ’° Mynt</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="score">0</span>
                    <span class="stat-label">â­ PoÃ¤ng</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="level">1</span>
                    <span class="stat-label">ðŸ† NivÃ¥</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="streak">0</span>
                    <span class="stat-label">ðŸ”¥ Streak</span>
                </div>
            </div>
            
            <!-- XP Bar -->
            <div class="xp-bar-container">
                <div class="xp-bar-label">
                    <span id="xp-current">0</span> / <span id="xp-needed">10</span> XP
                </div>
                <div class="xp-bar-bg">
                    <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="game-content">
            <div id="level-up-message"></div>

            <div id="game-mode-selector" class="game-mode-selector" style="display: block;">
                <h2>ðŸŽ® VÃ¤lj SpellÃ¤ge</h2>
                <div class="mode-buttons">
                    <button class="mode-btn" onclick="startGameMode('normal')">
                        <div class="mode-icon">ðŸ“</div>
                        <div class="mode-name">Normal</div>
                        <div class="mode-desc">Klassiskt spellÃ¤ge</div>
                    </button>
                    <button class="mode-btn" onclick="startGameMode('write')">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-name">Skriv Svar</div>
                        <div class="mode-desc">Skriv ditt svar!</div>
                    </button>
                    <button class="mode-btn" onclick="startGameMode('hard')">
                        <div class="mode-icon">ðŸ”¥</div>
                        <div class="mode-name">SvÃ¥r (6 alt)</div>
                        <div class="mode-desc">6 alternativ!</div>
                    </button>
                    <button class="mode-btn mode-btn-test" onclick="startGameMode('test')">
                        <div class="mode-icon">ðŸ“‹</div>
                        <div class="mode-name">Prov</div>
                        <div class="mode-desc">Diagnostiskt test!</div>
                    </button>
                    <button class="mode-btn" onclick="openTopicSelector()">
                        <div class="mode-icon">ðŸ“–</div>
                        <div class="mode-name">Ã„mnesval</div>
                        <div class="mode-desc">TrÃ¤na specifikt</div>
                    </button>
                    <button class="mode-btn mode-btn-special" onclick="open1v1Setup()">
                        <div class="mode-icon">ðŸ‘¥</div>
                        <div class="mode-name">1v1 Lokal</div>
                        <div class="mode-desc">2 spelare lokal!</div>
                    </button>
                    <button class="mode-btn mode-btn-premium" onclick="openPartySetup()">
                        <div class="mode-icon">ðŸŽ‰</div>
                        <div class="mode-name">Party Mode</div>
                        <div class="mode-desc">MÃ¥nga spelare online!</div>
                    </button>
                </div>
            </div>

            <div id="game-area" style="display: none;">
                <div id="game-mode-info"></div>
                
                <div style="text-align: center;">
                    <button class="change-mode-btn" onclick="confirmChangeMode()">
                        ðŸ”„ Byt SpellÃ¤ge
                    </button>
                </div>

            <div class="powerups" id="powerups-section">
                <button class="powerup-btn" id="hint-btn" onclick="useHint()">
                    ðŸ’¡ Hint (<span id="hint-count">3</span>)
                </button>
                <button class="powerup-btn" id="double-btn" onclick="useDoublePoints()">
                    âš¡ 2x PoÃ¤ng (<span id="double-count">2</span>)
                </button>
                <button class="powerup-btn" id="shield-btn" onclick="useShield()">
                    ðŸ›¡ï¸ SkÃ¶ld (<span id="shield-count">1</span>)
                </button>
                <button class="study-btn" onclick="openStudyModal()">
                    ðŸ“š Plugga
                </button>
            </div>

            <div class="question-card">
                <div class="question-text" id="question"></div>
                <div class="options" id="options"></div>
                <div id="feedback"></div>
                <button class="next-btn" id="next-btn" onclick="nextQuestion()" style="display: none;">
                    NÃ¤sta frÃ¥ga â†’
                </button>
            </div>

            <div class="shop" id="shop-section">
                <h2>ðŸ›’ Shoppen</h2>
                <div class="shop-items">
                    <div class="shop-item">
                        <h3>ðŸ’¡ Hint Pack</h3>
                        <p>+3 Hints</p>
                        <p><strong>50 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('hint')">KÃ¶p</button>
                    </div>
                    <div class="shop-item">
                        <h3>âš¡ Dubbel Kraft</h3>
                        <p>+2 DubbelpoÃ¤ng</p>
                        <p><strong>75 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('double')">KÃ¶p</button>
                    </div>
                    <div class="shop-item">
                        <h3>ðŸ›¡ï¸ SkÃ¶ldar</h3>
                        <p>+2 Skydd mot fel</p>
                        <p><strong>100 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('shield')">KÃ¶p</button>
                    </div>
                    <div class="shop-item">
                        <h3>ðŸŽ¯ PoÃ¤ngboost</h3>
                        <p>+500 poÃ¤ng direkt</p>
                        <p><strong>150 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('points')">KÃ¶p</button>
                    </div>
                    <div class="shop-item">
                        <h3>ðŸ”¥ Streak Saver</h3>
                        <p>RÃ¤dda din streak 1 gÃ¥ng</p>
                        <p><strong>200 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('streaksaver')">KÃ¶p</button>
                    </div>
                    <div class="shop-item">
                        <h3>ðŸ’° Mynt Magnet</h3>
                        <p>+50% mynt i 5 frÃ¥gor</p>
                        <p><strong>175 mynt</strong></p>
                        <button class="shop-btn" onclick="buyItem('coinboost')">KÃ¶p</button>
                    </div>
                </div>
            </div>

            <button class="stats-open-btn" onclick="openStatsModal()">
                ðŸ“Š Se Statistik & Achievements
            </button>
            </div>
        </div>
    </div>

    <!-- Study Modal -->
    <div id="studyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ðŸ“š Plugga Grammatik</h2>
                <button class="close-btn" onclick="closeStudyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="topic-buttons" id="topicButtons">
                    <button class="topic-btn active" onclick="showTopic('adjektiv')">Adjektiv</button>
                    <button class="topic-btn" onclick="showTopic('substantiv')">Substantiv</button>
                    <button class="topic-btn" onclick="showTopic('adverb')">Adverb</button>
                    <button class="topic-btn" onclick="showTopic('pronomen')">Pronomen</button>
                    <button class="topic-btn" onclick="showTopic('konjunktioner')">Konjunktioner</button>
                    <button class="topic-btn" onclick="showTopic('prepositioner')">Prepositioner</button>
                    <button class="topic-btn" onclick="showTopic('verb')">Verb</button>
                </div>
                
                <div class="study-search-container">
                    <input type="text" id="studySearchInput" class="study-search-input" placeholder="ðŸ” SÃ¶k i texten..." oninput="searchStudyContent()" />
                </div>
                
                <div id="studyContentArea" class="study-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ðŸ“Š Statistik & Achievements</h2>
                <button class="close-btn" onclick="closeStatsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="stats-section">
                    <h3>ðŸ† High Score</h3>
                    <div class="stat-value-large" id="statHighScore">0</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ”¥</div>
                        <div class="stat-label">LÃ¤ngsta Streak</div>
                        <div class="stat-card-value" id="statLongestStreak">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Totalt Mynt</div>
                        <div class="stat-card-value" id="statTotalCoins">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“</div>
                        <div class="stat-label">Totalt FrÃ¥gor</div>
                        <div class="stat-card-value" id="statTotalQuestions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â­</div>
                        <div class="stat-label">HÃ¶gsta NivÃ¥</div>
                        <div class="stat-card-value" id="statHighestLevel">1</div>
                    </div>
                </div>

                <div class="achievements-section">
                    <h3>ðŸ… Achievements</h3>
                    <div class="achievements-grid" id="achievementsGrid">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Selector Modal -->
    <div id="topicModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ðŸ“– VÃ¤lj Ã„mne</h2>
                <button class="close-btn" onclick="closeTopicModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="topic-selector-grid">
                    <button class="topic-select-btn" onclick="startTopicMode('Adjektiv')">
                        <div class="topic-select-icon">ðŸŽ¨</div>
                        <div class="topic-select-name">Adjektiv</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Substantiv')">
                        <div class="topic-select-icon">ðŸ“¦</div>
                        <div class="topic-select-name">Substantiv</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Adverb')">
                        <div class="topic-select-icon">âš¡</div>
                        <div class="topic-select-name">Adverb</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Pronomen')">
                        <div class="topic-select-icon">ðŸ”„</div>
                        <div class="topic-select-name">Pronomen</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Konjunktioner')">
                        <div class="topic-select-icon">ðŸ”—</div>
                        <div class="topic-select-name">Konjunktioner</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Prepositioner')">
                        <div class="topic-select-icon">ðŸ“</div>
                        <div class="topic-select-name">Prepositioner</div>
                    </button>
                    <button class="topic-select-btn" onclick="startTopicMode('Verb')">
                        <div class="topic-select-icon">ðŸƒ</div>
                        <div class="topic-select-name">Verb</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1v1 Setup Modal -->
    <div id="vs1v1SetupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);">
                <h2>ðŸ‘¥ 1v1 Mode - Setup</h2>
                <button class="close-btn" onclick="close1v1Setup()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="vs1v1-setup">
                    <h3>VÃ¤lj Speltid</h3>
                    <div class="time-input-container">
                        <label for="vs1v1TimeInput">â±ï¸ Minuter</label>
                        <input type="number" id="vs1v1TimeInput" class="time-number-input" min="1" max="10" value="2" />
                    </div>
                    
                    <div class="player-names">
                        <div class="player-name-input">
                            <label>ðŸŽ® Spelare 1</label>
                            <input type="text" id="player1Name" placeholder="Namn..." value="Spelare 1" />
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="player-name-input">
                            <label>ðŸŽ® Spelare 2</label>
                            <input type="text" id="player2Name" placeholder="Namn..." value="Spelare 2" />
                        </div>
                    </div>
                    
                    <button class="start-vs-btn" onclick="start1v1Game()" style="margin-top: 25px;">
                        ðŸŽ® Starta Matchen!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Party Mode Setup Modal -->
    <div id="partySetupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2>ðŸŽ‰ Party Mode</h2>
                <button class="close-btn" onclick="closePartySetup()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="party-setup">
                    <div class="party-tabs">
                        <button class="party-tab active" onclick="switchPartyTab('host')">Skapa Party</button>
                        <button class="party-tab" onclick="switchPartyTab('join')">GÃ¥ Med</button>
                    </div>
                    
                    <!-- HOST TAB -->
                    <div id="hostTab" class="party-tab-content">
                        <h3>Skapa ett Party</h3>
                        <div class="player-name-input">
                            <label>ðŸŽ® Ditt Namn</label>
                            <input type="text" id="partyHostName" placeholder="Namn..." />
                        </div>
                        <div class="player-name-input">
                            <label>ðŸ‘€ SpellÃ¤ge</label>
                            <div class="spectator-selection">
                                <button class="spectator-btn active" onclick="selectSpectatorMode(false)">
                                    ðŸŽ® Spela med
                                </button>
                                <button class="spectator-btn" onclick="selectSpectatorMode(true)">
                                    ðŸ‘€ Bara kolla
                                </button>
                            </div>
                        </div>
                        <div class="player-name-input">
                            <label>â±ï¸ Speltid</label>
                            <div class="time-input-container">
                                <input type="number" id="partyTimeInput" class="time-number-input" min="1" max="10" value="2" />
                                <span class="time-unit">minuter</span>
                            </div>
                        </div>
                        <button class="start-vs-btn" onclick="createParty()" style="margin-top: 25px;">
                            ðŸŽ‰ Skapa Party
                        </button>
                        
                        <div id="partyLobby" style="display: none;">
                            <h3 style="margin-top: 20px;">ðŸ“‹ Party Kod:</h3>
                            <div class="lobby-code-display">
                                <span id="partyCodeDisplay">------</span>
                                <button onclick="copyPartyCode()" class="copy-btn">ðŸ“‹</button>
                            </div>
                            
                            <h3 style="margin-top: 25px;">ðŸ‘¥ Spelare i lobbyn:</h3>
                            <div id="playersList" class="players-list"></div>
                            
                            <button class="start-vs-btn" onclick="startPartyGame()" style="margin-top: 20px;">
                                ðŸš€ Starta Party!
                            </button>
                        </div>
                    </div>
                    
                    <!-- JOIN TAB -->
                    <div id="joinTab" class="party-tab-content" style="display: none;">
                        <h3>GÃ¥ Med i Party</h3>
                        <div class="player-name-input">
                            <label>ðŸŽ® Ditt Namn</label>
                            <input type="text" id="partyJoinName" placeholder="Namn..." />
                        </div>
                        <div class="player-name-input">
                            <label>ðŸ”‘ Party Kod</label>
                            <input type="text" id="joinPartyCode" placeholder="6-siffrig kod" maxlength="6" />
                        </div>
                        <button class="start-vs-btn" onclick="joinParty()" style="margin-top: 25px;">
                            ðŸš€ GÃ¥ Med
                        </button>
                        
                        <div id="waitingArea" style="display: none; margin-top: 20px; text-align: center;">
                            <div class="loading-spinner"></div>
                            <p>VÃ¤ntar pÃ¥ att host startar...</p>
                            <h4 style="margin-top: 15px;">ðŸ‘¥ Spelare:</h4>
                            <div id="joinPlayersList" class="players-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Party Game Area (Fullscreen single player view) -->
    <div id="partyGameArea" style="display: none;">
        <div class="party-game-wrapper" id="partyGameWrapper">
            
            <!-- Top Bar with Timer and Score -->
            <div class="party-top-bar">
                <div class="party-timer">
                    â±ï¸ <span id="partyTimer">2:00</span>
                </div>
                <!-- Cancel Button (centered in top bar) -->
                <button id="partyCancelBtn" class="vs1v1-cancel-btn" onclick="cancelPartyGame()">
                    âŒ LÃ¤mna Party
                </button>
                <div class="party-my-score" id="partyMyScoreContainer">
                    <span id="partyMyName">Du</span>: <span id="partyMyScore" class="score-big">0</span> rÃ¤tt
                </div>
            </div>
            
            <!-- Question Area -->
            <div class="party-question-container" id="partyQuestionContainer">
                <div class="question-box party-question" id="partyQuestion"></div>
                <div class="options-grid" id="partyOptions"></div>
                <div id="partyFeedback" class="party-feedback"></div>
            </div>
            
            <!-- Live Leaderboard Sidebar -->
            <div class="party-leaderboard" id="partyLeaderboard">
                <h3>ðŸ† Live Ranking</h3>
                <div id="liveLeaderboard"></div>
            </div>
        </div>
    </div>

    <!-- 1v1 Game Area -->
    <div id="vs1v1GameArea" style="display: none;">
        <div class="vs1v1-wrapper">
            <!-- Stats Bar Top -->
            <div class="vs1v1-stats-top">
                <div class="player-stat-box">
                    <span id="player1NameDisplay" class="stat-name">Spelare 1</span>
                    <span id="player1ScoreNum" class="stat-score">0</span>
                </div>
                <div class="player-stat-box">
                    <span id="player2NameDisplay" class="stat-name">Spelare 2</span>
                    <span id="player2ScoreNum" class="stat-score">0</span>
                </div>
            </div>

            <!-- Timer Bar -->
            <div class="vs1v1-timer-bar">
                <span id="vs1v1Timer" class="timer-display">2:00</span>
            </div>

            <!-- Cancel Button -->
            <button id="vs1v1CancelBtn" class="vs1v1-cancel-btn" onclick="cancel1v1Game()">
                âŒ Avbryt Match
            </button>

            <!-- Split Screen Game Area -->
            <div class="vs1v1-game-split">
                <!-- Left Player -->
                <div class="vs1v1-side">
                    <div class="question-box" id="player1Question"></div>
                    <div class="options-grid" id="player1Options"></div>
                    <div id="player1Feedback" class="vs1v1-feedback"></div>
                </div>

                <!-- VS Divider -->
                <div class="vs-divider">VS</div>

                <!-- Right Player -->
                <div class="vs1v1-side">
                    <div class="question-box" id="player2Question"></div>
                    <div class="options-grid" id="player2Options"></div>
                    <div id="player2Feedback" class="vs1v1-feedback"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h2 id="results-title">ðŸŽ‰ Spelet Slut!</h2>
                <button class="close-btn" onclick="closeResultsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="results-content" class="results-display">
                    <!-- Will be filled by JS -->
                </div>
                <div class="results-actions">
                    <button class="results-btn share-btn" onclick="shareResults()">
                        ðŸ“¤ Dela Resultat
                    </button>
                    <button class="results-btn menu-btn" onclick="closeResultsModalAndReturn()">
                        ðŸ  Tillbaka till Menyn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const studyMaterials = {
            adjektiv: `
                <h3>ðŸŽ¨ Vad Ã¤r Adjektiv?</h3>
                <p>Adjektiv beskriver egenskaper hos substantiv. De svarar pÃ¥ frÃ¥gan "hur Ã¤r det?"</p>
                <div class="example-box">
                    <strong>Exempel:</strong> En <strong>rÃ¶d</strong> cykel, ett <strong>stort</strong> hus, flera <strong>glada</strong> barn
                </div>

                <h3>ðŸ“Š BÃ¶jning av Adjektiv</h3>
                <p><strong>KongruensbÃ¶jning</strong> - adjektivet anpassar sig efter substantivets:</p>
                <ul>
                    <li><strong>Genus:</strong> en-ord (utrum) eller ett-ord (neutrum)</li>
                    <li><strong>Numerus:</strong> singular eller plural</li>
                    <li><strong>Species:</strong> bestÃ¤md eller obestÃ¤md form</li>
                </ul>

                <div class="example-box">
                    <strong>ObestÃ¤md (stark):</strong> en rÃ¶d cykel, ett rÃ¶tt hus<br>
                    <strong>BestÃ¤md (svag):</strong> den rÃ¶da cykeln, det rÃ¶da huset
                </div>

                <h3>ðŸ“ˆ Komparation (JÃ¤mfÃ¶relse)</h3>
                <ul>
                    <li><strong>Positiv:</strong> dum (grundform)</li>
                    <li><strong>Komparativ:</strong> dummare (mer)</li>
                    <li><strong>Superlativ:</strong> dummast (mest)</li>
                </ul>

                <p><strong>Tre sÃ¤tt att komparera:</strong></p>
                <ul>
                    <li><strong>Morfologiskt:</strong> dum â†’ dummare â†’ dummast</li>
                    <li><strong>Perifrastiskt:</strong> intressant â†’ mer intressant â†’ mest intressant</li>
                    <li><strong>Suppletivt:</strong> gammal â†’ Ã¤ldre â†’ Ã¤ldst (helt olika ordformer)</li>
                </ul>
            `,
            
            substantiv: `
                <h3>ðŸ“¦ Vad Ã¤r Substantiv?</h3>
                <p>Substantiv Ã¤r ord som namnger saker, personer, platser och begrepp. Du kan sÃ¤tta <strong>en</strong>, <strong>ett</strong> eller <strong>flera</strong> framfÃ¶r dem.</p>

                <h3>ðŸ” Typer av Substantiv</h3>
                <ul>
                    <li><strong>Konkreta:</strong> SÃ¥dant du kan ta pÃ¥ (gitarr, piano, fotoram)</li>
                    <li><strong>Abstrakta:</strong> SÃ¥dant du inte kan ta pÃ¥ (hunger, glÃ¤dje, koncept)</li>
                    <li><strong>Egennamn:</strong> Namn pÃ¥ personer, orter, fÃ¶retag (Mikael, Paris, Amnesty)</li>
                </ul>

                <h3>ðŸ“Š BÃ¶jningar</h3>
                <p><strong>Genus:</strong></p>
                <ul>
                    <li><strong>Utrum (en-ord):</strong> en sko, en gitarr</li>
                    <li><strong>Neutrum (ett-ord):</strong> ett paraply, ett hus</li>
                </ul>

                <p><strong>Numerus (antal):</strong></p>
                <ul>
                    <li><strong>Singular:</strong> en stol</li>
                    <li><strong>Plural:</strong> flera stolar</li>
                </ul>

                <p><strong>Species (bestÃ¤mdhet):</strong></p>
                <ul>
                    <li><strong>ObestÃ¤md:</strong> stol, hus</li>
                    <li><strong>BestÃ¤md:</strong> stolen, huset</li>
                </ul>

                <p><strong>Kasus (Ã¤gande):</strong></p>
                <ul>
                    <li><strong>Grundform:</strong> Mikael</li>
                    <li><strong>Genitiv:</strong> Mikaels (lÃ¤gg till -s)</li>
                </ul>

                <h3>ðŸ”¢ De 6 Deklinationerna (pluralÃ¤ndelser)</h3>
                <ul>
                    <li><strong>1:a dekl (-or):</strong> flicka â†’ flickor</li>
                    <li><strong>2:a dekl (-ar):</strong> pojke â†’ pojkar</li>
                    <li><strong>3:e dekl (-er):</strong> stad â†’ stÃ¤der</li>
                    <li><strong>4:e dekl (-r):</strong> linje â†’ linjer</li>
                    <li><strong>5:e dekl (-n):</strong> mÃ¤rke â†’ mÃ¤rken</li>
                    <li><strong>6:e dekl (ingen):</strong> barn â†’ barn, hus â†’ hus</li>
                </ul>

                <h3>ðŸ‘‘ Genitiv (Ã„gande)</h3>
                <ul>
                    <li><strong>Ã„gandegenitiv:</strong> Mikaels bil (Mikael Ã¤ger bilen)</li>
                    <li><strong>Subjektiv genitiv:</strong> Studentens dammsugning (studenten utfÃ¶r handlingen)</li>
                    <li><strong>Objektiv genitiv:</strong> Palmes begravning (Palme blir begravd)</li>
                    <li><strong>MÃ¥ttsgenitiv:</strong> tvÃ¥ meters fÃ¶rsprÃ¥ng, ett Ã¥rs fÃ¶rberedelser</li>
                </ul>
            `,
            
            adverb: `
                <h3>âš¡ Vad Ã¤r Adverb?</h3>
                <p>Adverb beskriver <strong>hur, nÃ¤r, var</strong> eller <strong>varifrÃ¥n</strong> nÃ¥got hÃ¤nder. De beskriver verb, inte substantiv!</p>

                <h3>â“ FrÃ¥gor som Adverb Svarar PÃ¥</h3>
                <ul>
                    <li><strong>NÃ¥r?</strong> nu, snart, igÃ¥r, aldrig</li>
                    <li><strong>Var?</strong> hÃ¤r, dÃ¤r, ute, hemma</li>
                    <li><strong>VarifrÃ¥n?</strong> hemifrÃ¥n, nerifrÃ¥n</li>
                    <li><strong>Hur?</strong> fort, snabbt, lÃ¥ngsamt, bra</li>
                </ul>

                <h3>ðŸ”„ TvÃ¥ Sorters Adverb</h3>
                <ul>
                    <li><strong>SmÃ¥ord som inte bÃ¶js:</strong> hÃ¤r, dÃ¤r, nu, dÃ¥, hit, dit</li>
                    <li><strong>Ord som liknar adjektiv:</strong> Men de beskriver verb, inte substantiv</li>
                </ul>

                <h3>ðŸŽ¯ Adverb vs Adjektiv</h3>
                <div class="example-box">
                    <strong>Adverb (beskriver verb):</strong><br>
                    Lejonet reagerade <strong>blixtsnabbt</strong>.<br>
                    (hur reagerade det? â†’ beskriver "reagerade")<br><br>
                    
                    <strong>Adjektiv (beskriver substantiv):</strong><br>
                    Lejonet var <strong>blixtsnabbt</strong>.<br>
                    (hur var lejonet? â†’ beskriver "lejonet")
                </div>

                <h3>ðŸ“ Viktig Regel</h3>
                <p><strong>Adjektiv bÃ¶js</strong> efter substantivet:</p>
                <ul>
                    <li>Lejonet var blixtsnabb<strong>t</strong></li>
                    <li>Lejonen var blixtsnabb<strong>a</strong></li>
                </ul>

                <p><strong>Adverb bÃ¶js ALDRIG:</strong></p>
                <ul>
                    <li>Lejonet reagerade blixtsnabbt</li>
                    <li>Lejonen reagerade blixtsnabbt (samma!)</li>
                </ul>
            `,
            
            pronomen: `
                <h3>ðŸ”„ Vad Ã¤r Pronomen?</h3>
                <p>Pronomen betyder "i stÃ¤llet fÃ¶r namn". De <strong>ersÃ¤tter substantiv eller adjektiv</strong> i meningar.</p>

                <h3>ðŸ’¡ VarfÃ¶r AnvÃ¤nder Vi Pronomen?</h3>
                <p>FÃ¶r att slippa upprepa samma ord hela tiden!</p>
                <div class="example-box">
                    <strong>Utan pronomen:</strong> Maria sÃ¥g Maria i spegeln. Maria var nÃ¶jd med Maria.<br>
                    <strong>Med pronomen:</strong> Maria sÃ¥g <strong>sig</strong> i spegeln. <strong>Hon</strong> var nÃ¶jd med <strong>sig sjÃ¤lv</strong>.
                </div>

                <h3>ðŸ“ Vanliga Pronomen</h3>
                <ul>
                    <li><strong>Personliga:</strong> jag, du, han, hon, den, det, vi, ni, de</li>
                    <li><strong>Possessiva (Ã¤gande):</strong> min, mitt, mina, din, hans, hennes, sin</li>
                    <li><strong>Demonstrativa (pekande):</strong> den hÃ¤r, det dÃ¤r, denna, dessa</li>
                    <li><strong>Indefinita (obestÃ¤mda):</strong> nÃ¥gra, flera, alla, varje</li>
                    <li><strong>Interrogativa (frÃ¥gande):</strong> vem, vad, vilken</li>
                </ul>

                <h3>ðŸŽ¯ Exempel i Meningar</h3>
                <div class="example-box">
                    <strong>Hon</strong> var glad. (ersÃ¤tter personens namn)<br>
                    Jag vill ha <strong>de hÃ¤r</strong>! (ersÃ¤tter t.ex. "Ã¤pplena")<br>
                    <strong>Min</strong> lÃ¤xa. (ersÃ¤tter "Mikaels" eller annat namn)
                </div>
            `,
            
            konjunktioner: `
                <h3>ðŸ”— Vad Ã¤r Konjunktioner?</h3>
                <p>Konjunktioner Ã¤r <strong>bindeord</strong> som knyter ihop ord, fraser eller satser av samma typ.</p>

                <h3>ðŸ“‹ Vanliga Konjunktioner</h3>
                <p><strong>och, men, eller, fÃ¶r, ty, sÃ¥</strong></p>

                <h3>ðŸŽ¯ Vad Kan De Binda Ihop?</h3>
                <ul>
                    <li><strong>Ord:</strong> Kalle <strong>och</strong> Lisa</li>
                    <li><strong>Fraser:</strong> nu <strong>och</strong> dÃ¥</li>
                    <li><strong>Satser:</strong> Olle sjunger <strong>och</strong> Lisa spelar</li>
                </ul>

                <h3>ðŸ“Š Typer av Konjunktioner</h3>
                <ul>
                    <li><strong>Additiva (lÃ¤gger till):</strong> och, samt<br>
                    <em>Exempel: Jag vill ha glass och kakor</em></li>
                    
                    <li><strong>Disjunktiva (alternativ):</strong> eller<br>
                    <em>Exempel: Vill du ha kaffe eller te?</em></li>
                    
                    <li><strong>Adversativa (motsats):</strong> men, fast, utan<br>
                    <em>Exempel: Jag Ã¤r trÃ¶tt men glad</em></li>
                    
                    <li><strong>Explanativa (fÃ¶rklarande):</strong> ty, fÃ¶r<br>
                    <em>Exempel: Jag stannar hemma, eftersom jag Ã¤r sjuk</em></li>
                    
                    <li><strong>Konklusiva (slutsats):</strong> sÃ¥<br>
                    <em>Exempel: Jag var trÃ¶tt, sÃ¥ jag somnade</em></li>
                </ul>

                <div class="example-box">
                    <strong>Test dig sjÃ¤lv:</strong><br>
                    Anna kommer inte ___ Bo har kvÃ¤llspasset.<br>
                    Prova: och, men, ty, sÃ¥, fÃ¶r<br>
                    MÃ¤rker du hur betydelsen Ã¤ndras?
                </div>
            `,
            
            prepositioner: `
                <h3>ðŸ“ Vad Ã¤r Prepositioner?</h3>
                <p>Prepositioner Ã¤r <strong>obÃ¶jliga smÃ¥ord</strong> som beskriver relationer i <strong>rum, tid</strong> eller mellan saker.</p>

                <h3>ðŸ“‹ Vanliga Prepositioner</h3>
                <p><strong>i, pÃ¥, under, Ã¶ver, bredvid, till, frÃ¥n, bakom, framfÃ¶r, med, av, fÃ¶r</strong></p>

                <h3>ðŸŒ Prepositioner fÃ¶r Plats</h3>
                <ul>
                    <li><strong>i:</strong> Katten Ã¤r <strong>i</strong> lÃ¥dan</li>
                    <li><strong>pÃ¥:</strong> Boken ligger <strong>pÃ¥</strong> bordet</li>
                    <li><strong>under:</strong> Hunden sover <strong>under</strong> sÃ¤ngen</li>
                    <li><strong>Ã¶ver:</strong> Lampan hÃ¤nger <strong>Ã¶ver</strong> bordet</li>
                    <li><strong>bredvid:</strong> Stolen stÃ¥r <strong>bredvid</strong> dÃ¶rren</li>
                    <li><strong>bakom:</strong> Bilen stÃ¥r <strong>bakom</strong> huset</li>
                    <li><strong>framfÃ¶r:</strong> Vi stÃ¥r <strong>framfÃ¶r</strong> skolan</li>
                </ul>

                <h3>â° Prepositioner fÃ¶r Tid</h3>
                <ul>
                    <li><strong>om:</strong> Vi ses <strong>om</strong> en timme</li>
                    <li><strong>i:</strong> Jag Ã¤r ledig <strong>i</strong> sommar</li>
                    <li><strong>pÃ¥:</strong> Vi trÃ¤ffas <strong>pÃ¥</strong> fredag</li>
                    <li><strong>efter:</strong> Kom <strong>efter</strong> lunch</li>
                    <li><strong>fÃ¶re:</strong> Kom <strong>fÃ¶re</strong> klockan tre</li>
                </ul>

                <h3>ðŸ”— Prepositioner fÃ¶r Relation</h3>
                <ul>
                    <li><strong>med:</strong> Jag Ã¥ker <strong>med</strong> dig</li>
                    <li><strong>till:</strong> Presenten Ã¤r <strong>till</strong> dig</li>
                    <li><strong>frÃ¥n:</strong> Brevet Ã¤r <strong>frÃ¥n</strong> mamma</li>
                    <li><strong>av:</strong> Gjord <strong>av</strong> trÃ¤</li>
                    <li><strong>fÃ¶r:</strong> Det Ã¤r bra <strong>fÃ¶r</strong> hÃ¤lsan</li>
                </ul>

                <div class="example-box">
                    <strong>Kom ihÃ¥g:</strong> Prepositioner bÃ¶js ALDRIG!<br>
                    De Ã¤r alltid samma oavsett vad de beskriver.
                </div>
            `,
            
            verb: `
                <h3>ðŸƒ Vad Ã¤r Verb?</h3>
                <p>Verb betecknar <strong>handlingar, hÃ¤ndelser eller tillstÃ¥nd</strong>. Du kan ofta sÃ¤tta "att" framfÃ¶r grundformen.</p>

                <h3>ðŸŽ¯ Tre Typer av Verb</h3>
                <ul>
                    <li><strong>Handlingar:</strong> hoppa, sjunga, krama, springa</li>
                    <li><strong>HÃ¤ndelser:</strong> ramla, fÃ¶das, explodera</li>
                    <li><strong>TillstÃ¥nd:</strong> vara, bo, heta, hata</li>
                </ul>

                <h3>ðŸ“Š Verbets Temaformer</h3>
                <p>De fyra grundformer du behÃ¶ver kunna:</p>
                <ul>
                    <li><strong>Infinitiv (att...?):</strong> att kalla, att ringa, att finna</li>
                    <li><strong>Presens (nu):</strong> kallar, ringer, finner</li>
                    <li><strong>Preteritum (dÃ¥):</strong> kallade, ringde, fann</li>
                    <li><strong>Supinum (har/hade):</strong> kallat, ringt, funnit</li>
                </ul>

                <h3>â° Tempus - NÃ¤r HÃ¤nder Det?</h3>
                <div class="example-box">
                    <strong>Enkla tempus (utan hjÃ¤lpverb):</strong><br>
                    â€¢ <strong>Presens:</strong> Jag springer (nu/brukar)<br>
                    â€¢ <strong>Preteritum:</strong> Jag sprang (dÃ¥/igÃ¥r)<br><br>

                    <strong>Sammansatta tempus (med hjÃ¤lpverb):</strong><br>
                    â€¢ <strong>Perfekt:</strong> Jag har sprungit (har hÃ¤nt)<br>
                    â€¢ <strong>Pluskvamperfekt:</strong> Jag hade sprungit (hade hÃ¤nt fÃ¶re)<br>
                    â€¢ <strong>Futurum:</strong> Jag ska springa (kommer att hÃ¤nda)
                </div>

                <h3>ðŸ”§ HjÃ¤lpverb</h3>
                <p>Verb som hjÃ¤lper till att skapa olika tidsformer:</p>
                <p><strong>har, hade, ska, kommer att, vill, kan, mÃ¥ste</strong></p>

                <h3>ðŸ“ Olika Verbtyper</h3>
                <ul>
                    <li><strong>Dynamiska verb:</strong> Visar rÃ¶relse (springa, krypa, gÃ¥)</li>
                    <li><strong>TillstÃ¥ndsverb:</strong> Visar hur nÃ¥got Ã¤r (heta, bo, vara)</li>
                    <li><strong>Gradvisa Ã¶vergÃ¥ngsverb:</strong> LÃ¥ngsam fÃ¶rÃ¤ndring (baka, bygga, Ã¤ta)</li>
                    <li><strong>Momentana Ã¶vergÃ¥ngsverb:</strong> PlÃ¶tslig hÃ¤ndelse (hitta, tappa, dÃ¶)</li>
                </ul>

                <div class="example-box">
                    <strong>Kom ihÃ¥g:</strong> Supinum anvÃ¤nds ALLTID tillsammans med har eller hade!<br>
                    âœ… Jag har sprungit<br>
                    âŒ Jag sprungit
                </div>
            `
        };

        const questions = [
            // ADJEKTIV
            {
                question: "Vad beskriver ett adjektiv?",
                options: ["Ett verb", "Ett substantiv", "Ett adverb", "En preposition"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Hur bÃ¶js adjektiv i svensk grammatik?",
                options: ["Efter tempus", "Efter kasus", "Efter genus, numerus och species", "Efter person"],
                correct: 2,
                category: "Adjektiv"
            },
            {
                question: "Vilken bÃ¶jning Ã¤r 'den rÃ¶da cykeln' ett exempel pÃ¥?",
                options: ["Stark bÃ¶jning", "Svag bÃ¶jning", "Perifrastisk bÃ¶jning", "Suppletiv bÃ¶jning"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Vad kallas det nÃ¤r man jÃ¤mfÃ¶r adjektiv med morfem som -are och -ast?",
                options: ["Perifrastisk komparation", "Suppletiv komparation", "Morfologisk komparation", "Defektiv komparation"],
                correct: 2,
                category: "Adjektiv"
            },
            {
                question: "Vilket Ã¤r superlativformen av 'intressant'?",
                options: ["Intressantast", "Mest intressant", "Intressantare", "Mer intressant"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Hur ska adjektivet bÃ¶jas: 'Ett ___ Ã¤pple'?",
                options: ["RÃ¶d", "RÃ¶da", "RÃ¶tt", "RÃ¶de"],
                correct: 2,
                category: "Adjektiv"
            },
            {
                question: "Vilken komparation anvÃ¤nder 'mer' och 'mest'?",
                options: ["Morfologisk", "Perifrastisk", "Suppletiv", "Definitiv"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Vad Ã¤r 'bra, bÃ¤ttre, bÃ¤st' ett exempel pÃ¥?",
                options: ["Morfologisk komparation", "Perifrastisk komparation", "Suppletiv komparation", "Ingen komparation"],
                correct: 2,
                category: "Adjektiv"
            },
            // SUBSTANTIV
            {
                question: "Vad kan man sÃ¤tta framfÃ¶r ett substantiv?",
                options: ["Hur, nÃ¤r, var", "En, ett eller flera", "Ã„r, var, blir", "Och, men, eller"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vilket av dessa Ã¤r ett abstrakt substantiv?",
                options: ["Piano", "Hummer", "GlÃ¤dje", "Fotoram"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "Hur mÃ¥nga deklinationer finns det i svenskan?",
                options: ["4", "5", "6", "7"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "Vilken deklination har pluralÃ¤ndelsen -or?",
                options: ["FÃ¶rsta", "Andra", "Tredje", "FjÃ¤rde"],
                correct: 0,
                category: "Substantiv"
            },
            {
                question: "Vad Ã¤r 'Mikaels bil' ett exempel pÃ¥?",
                options: ["Objektiv genitiv", "Subjektiv genitiv", "Ã„gandegenitiv", "MÃ¥ttsgenitiv"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "Vilket genus har ordet 'paraply'?",
                options: ["Utrum", "Neutrum", "Maskulinum", "Femininum"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vilken Ã¤r den sjÃ¤tte deklinationen?",
                options: ["Deklinationen med -n", "Deklinationen med -r", "Deklinationen utan pluralÃ¤ndelse", "Deklinationen med -er"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "Vad Ã¤r 'Palmes begravning' ett exempel pÃ¥?",
                options: ["Subjektiv genitiv", "Objektiv genitiv", "Ã„gandegenitiv", "MÃ¥ttsgenitiv"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vilken pluralÃ¤ndelse har ordet 'pojke'?",
                options: ["-or", "-ar", "-er", "-r"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vilket Ã¤r ett konkret substantiv?",
                options: ["KÃ¤rlek", "Gitarr", "Hunger", "Koncept"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vad Ã¤r 'ett Ã¥rs fÃ¶rberedelser' ett exempel pÃ¥?",
                options: ["Ã„gandegenitiv", "Subjektiv genitiv", "Objektiv genitiv", "MÃ¥ttsgenitiv"],
                correct: 3,
                category: "Substantiv"
            },
            // ADVERB
            {
                question: "Vad beskriver adverb ofta?",
                options: ["Substantiv", "Adjektiv", "Hur, nÃ¤r, var nÃ¥got hÃ¤nder", "Kasus"],
                correct: 2,
                category: "Adverb"
            },
            {
                question: "Vilket ord Ã¤r ett adverb: 'Hunden sprang snabbt hem'?",
                options: ["Hunden", "Sprang", "Snabbt", "Hem"],
                correct: 2,
                category: "Adverb"
            },
            {
                question: "BÃ¶js adverb i svensk grammatik?",
                options: ["Ja, alltid", "Nej, aldrig", "Bara ibland", "Endast i plural"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "Vilket ord Ã¤r ett tidsbeskrivande adverb?",
                options: ["HÃ¤r", "Snabbt", "IgÃ¥r", "Bra"],
                correct: 2,
                category: "Adverb"
            },
            {
                question: "I 'Katten jagas vilt', vilket ord Ã¤r adverb?",
                options: ["Katten", "Jagas", "Vilt", "Inget"],
                correct: 2,
                category: "Adverb"
            },
            {
                question: "Vilket beskriver VAR nÃ¥got hÃ¤nder?",
                options: ["Snart", "HÃ¤r", "Snabbt", "Alltid"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "I 'Bilen kÃ¶rde fort', vad beskriver 'fort'?",
                options: ["Bilen", "Verbet kÃ¶rde", "En preposition", "Ett substantiv"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "Ã„r 'blixtsnabbt' adjektiv eller adverb i: 'Han svarade blixtsnabbt'?",
                options: ["Adjektiv", "Adverb", "Substantiv", "Verb"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "Vilket Ã¤r ett platsbeskrivande adverb?",
                options: ["Sedan", "DÃ¤r", "Ofta", "Kanske"],
                correct: 1,
                category: "Adverb"
            },
            // PRONOMEN
            {
                question: "Vad ersÃ¤tter pronomen?",
                options: ["Verb", "Substantiv eller adjektiv", "Adverb", "Konjunktioner"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "Vilket Ã¤r ett personligt pronomen?",
                options: ["Vilken", "Hon", "Min", "NÃ¥gra"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "Vad betyder ordet 'pronomen' bokstavligen?",
                options: ["FramfÃ¶r namnet", "I stÃ¤llet fÃ¶r namn", "Efter namnet", "Namn pÃ¥ saker"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "I 'Maria sÃ¥g sig i spegeln', vad Ã¤r 'sig'?",
                options: ["Substantiv", "Verb", "Pronomen", "Adjektiv"],
                correct: 2,
                category: "Pronomen"
            },
            {
                question: "Vilket Ã¤r ett possessivt pronomen?",
                options: ["Hon", "Vem", "Din", "DÃ¤r"],
                correct: 2,
                category: "Pronomen"
            },
            {
                question: "I 'De hÃ¤r Ã¤pplena Ã¤r goda', vad Ã¤r 'De hÃ¤r'?",
                options: ["Verb", "Pronomen", "Adjektiv", "Adverb"],
                correct: 1,
                category: "Pronomen"
            },
            // KONJUNKTIONER
            {
                question: "Vad gÃ¶r konjunktioner?",
                options: ["Beskriver substantiv", "Knyter ihop ord, fraser eller satser", "ErsÃ¤tter verb", "Visar kasus"],
                correct: 1,
                category: "Konjunktioner"
            },
            {
                question: "Vilken typ av konjunktion Ã¤r 'men'?",
                options: ["Additiv", "Disjunktiv", "Adversativ", "Konklusiv"],
                correct: 2,
                category: "Konjunktioner"
            },
            {
                question: "Vad kallas konjunktioner som visar val mellan tvÃ¥ saker?",
                options: ["Additiva", "Disjunktiva", "Explanativa", "Konklusiva"],
                correct: 1,
                category: "Konjunktioner"
            },
            {
                question: "I 'Jag stannar hemma, eftersom jag Ã¤r sjuk', vilken typ Ã¤r 'eftersom'?",
                options: ["Additiv", "Explanativ", "Adversativ", "Disjunktiv"],
                correct: 1,
                category: "Konjunktioner"
            },
            {
                question: "Vilken konjunktion lÃ¤gger till information?",
                options: ["Men", "Eller", "Och", "SÃ¥"],
                correct: 2,
                category: "Konjunktioner"
            },
            {
                question: "Vad Ã¤r 'sÃ¥' fÃ¶r typ av konjunktion?",
                options: ["Additiv", "Adversativ", "Konklusiv", "Disjunktiv"],
                correct: 2,
                category: "Konjunktioner"
            },
            // PREPOSITIONER
            {
                question: "Vad beskriver prepositioner ofta?",
                options: ["Verb", "Relationer i rum, tid eller mellan saker", "Adjektiv", "Endast personer"],
                correct: 1,
                category: "Prepositioner"
            },
            {
                question: "Vilket Ã¤r en preposition?",
                options: ["Och", "Snabbt", "Under", "Hon"],
                correct: 2,
                category: "Prepositioner"
            },
            {
                question: "I 'Boken ligger pÃ¥ bordet', vilken Ã¤r prepositionen?",
                options: ["Boken", "Ligger", "PÃ¥", "Bordet"],
                correct: 2,
                category: "Prepositioner"
            },
            {
                question: "Vilken preposition visar plats: 'Katten Ã¤r ___ lÃ¥dan'?",
                options: ["Efter", "Med", "I", "Av"],
                correct: 2,
                category: "Prepositioner"
            },
            {
                question: "I 'Vi gÃ¥r till skolan', vad Ã¤r 'till'?",
                options: ["Verb", "Adverb", "Preposition", "Konjunktion"],
                correct: 2,
                category: "Prepositioner"
            },
            {
                question: "BÃ¶js prepositioner?",
                options: ["Ja, alltid", "Nej, aldrig", "Bara i plural", "Efter genus"],
                correct: 1,
                category: "Prepositioner"
            },
            // VERB
            {
                question: "Vad betecknar verb?",
                options: ["Endast handlingar", "Handlingar, hÃ¤ndelser eller tillstÃ¥nd", "Endast tillstÃ¥nd", "Egenskaper"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "Hur mÃ¥nga temaformer har ett svenskt verb?",
                options: ["2", "3", "4", "5"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vilket hjÃ¤lpverb anvÃ¤nds med supinum?",
                options: ["Ska", "Kommer att", "Har eller hade", "Vill"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vilket tempus Ã¤r 'hade sprungit'?",
                options: ["Perfekt", "Preteritum", "Pluskvamperfekt", "Futurum"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vad kan man sÃ¤tta framfÃ¶r verb i grundform?",
                options: ["En", "Det", "Att", "Ã„r"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vilket Ã¤r ett tillstÃ¥ndsverb?",
                options: ["Springa", "Hoppa", "Vara", "Kasta"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vad Ã¤r presens av 'att finna'?",
                options: ["Fann", "Funnit", "Finner", "Finnar"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vilket tempus Ã¤r 'jag Ã¤ter'?",
                options: ["Preteritum", "Presens", "Perfekt", "Futurum"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "Vad Ã¤r supinum av 'att springa'?",
                options: ["Sprang", "Springer", "Sprungit", "Springit"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "I 'Jag ska Ã¤ta', vilket Ã¤r hjÃ¤lpverbet?",
                options: ["Jag", "Ska", "Ã„ta", "Inget hjÃ¤lpverb"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "Vilket verb visar en plÃ¶tslig hÃ¤ndelse?",
                options: ["Bygga", "Ã„ta", "Tappa", "Baka"],
                correct: 2,
                category: "Verb"
            },
            {
                question: "Vad Ã¤r preteritum av 'att ringa'?",
                options: ["Ringer", "Ringde", "Ringt", "Ringit"],
                correct: 1,
                category: "Verb"
            },
            // NYA FRÃ…GOR - Adjektiv (5 st)
            {
                question: "Vilket ord Ã¤r adjektiv i 'Den fina blomman luktar gott'?",
                options: ["Blomman", "Fina", "Luktar", "Gott"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Vilken Ã¤r komparativ form av 'klok'?",
                options: ["Klokare", "Klokast", "Klokare", "Mest klok"],
                correct: 0,
                category: "Adjektiv"
            },
            {
                question: "I 'Det var en spÃ¤nnande film', vad Ã¤r 'spÃ¤nnande'?",
                options: ["Verb", "Substantiv", "Adjektiv", "Adverb"],
                correct: 2,
                category: "Adjektiv"
            },
            {
                question: "Vilket adjektiv beskriver temperatur?",
                options: ["Snabb", "Varm", "Glad", "Stor"],
                correct: 1,
                category: "Adjektiv"
            },
            {
                question: "Vad Ã¤r superlativ av 'tung'?",
                options: ["Tungare", "Tyngst", "Tyngre", "Mest tung"],
                correct: 1,
                category: "Adjektiv"
            },
            // NYA FRÃ…GOR - Substantiv (5 st)
            {
                question: "Vilket substantiv Ã¤r abstrakt?",
                options: ["Bok", "GlÃ¤dje", "Stol", "Hund"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vad Ã¤r plural av 'mus'?",
                options: ["Muser", "Musar", "MÃ¶ss", "Mussen"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "I 'Barnen leker i parken', vilket ord Ã¤r substantiv?",
                options: ["Leker", "I", "Barnen", "Alla ovan"],
                correct: 2,
                category: "Substantiv"
            },
            {
                question: "Vilket substantiv Ã¤r ett konkret substantiv?",
                options: ["KÃ¤rlek", "Cykel", "Frihet", "Sorg"],
                correct: 1,
                category: "Substantiv"
            },
            {
                question: "Vad Ã¤r bestÃ¤md form singular av 'fÃ¥gel'?",
                options: ["FÃ¥geln", "FÃ¥glar", "FÃ¥glarna", "FÃ¥gelen"],
                correct: 0,
                category: "Substantiv"
            },
            // NYA FRÃ…GOR - Adverb (5 st)
            {
                question: "I 'Hon sjunger vackert', vad Ã¤r 'vackert'?",
                options: ["Adjektiv", "Adverb", "Verb", "Substantiv"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "Vilket adverb beskriver tid?",
                options: ["Snabbt", "IgÃ¥r", "HÃ¶gt", "Varsamt"],
                correct: 1,
                category: "Adverb"
            },
            {
                question: "I 'De Ã¥kte dit igÃ¥r', vad Ã¤r 'dit'?",
                options: ["Platsadverb", "Tidsadverb", "SÃ¤ttsadverb", "Gradadverb"],
                correct: 0,
                category: "Adverb"
            },
            {
                question: "Vilket adverb visar grad?",
                options: ["HÃ¤r", "Snart", "Mycket", "Aldrig"],
                correct: 2,
                category: "Adverb"
            },
            {
                question: "I 'Han kom precis', vad beskriver 'precis'?",
                options: ["Plats", "Tid", "SÃ¤tt", "Grad"],
                correct: 1,
                category: "Adverb"
            },
            // NYA FRÃ…GOR - Pronomen (5 st)
            {
                question: "I 'Det Ã¤r mitt', vad Ã¤r 'mitt'?",
                options: ["Personligt pronomen", "Possessivt pronomen", "Demonstrativt pronomen", "Reflexivt pronomen"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "Vilket Ã¤r ett reflexivt pronomen?",
                options: ["Jag", "Sig", "Vem", "Denna"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "I 'Vilken vill du ha?', vad Ã¤r 'vilken'?",
                options: ["Interrogativt pronomen", "Relativt pronomen", "Personligt pronomen", "Indefinit pronomen"],
                correct: 0,
                category: "Pronomen"
            },
            {
                question: "Vilket pronomen Ã¤r demonstrativt?",
                options: ["Han", "Denna", "NÃ¥gon", "Mig"],
                correct: 1,
                category: "Pronomen"
            },
            {
                question: "I 'Alla kom', vad Ã¤r 'alla'?",
                options: ["Personligt pronomen", "Indefinit pronomen", "Possessivt pronomen", "Reflexivt pronomen"],
                correct: 1,
                category: "Pronomen"
            },
            // NYA FRÃ…GOR - Konjunktioner (5 st)
            {
                question: "I 'Jag gillar bÃ¥de kaffe och te', vad Ã¤r 'bÃ¥de...och'?",
                options: ["Underordnande", "Samordnande", "Konjunktionsled", "Bindeord"],
                correct: 1,
                category: "Konjunktioner"
            },
            {
                question: "Vilket Ã¤r en underordnande konjunktion?",
                options: ["Eller", "Men", "Medan", "Och"],
                correct: 2,
                category: "Konjunktioner"
            },
            {
                question: "I 'Han stannade hemma fast han var frisk', vad Ã¤r 'fast'?",
                options: ["Adverb", "Underordnande konjunktion", "Samordnande konjunktion", "Preposition"],
                correct: 1,
                category: "Konjunktioner"
            },
            {
                question: "Vilken konjunktion visar motsats?",
                options: ["Och", "FÃ¶r", "Men", "SÃ¥"],
                correct: 2,
                category: "Konjunktioner"
            },
            {
                question: "I 'Hon sover nÃ¤r hon Ã¤r trÃ¶tt', vad Ã¤r 'nÃ¤r'?",
                options: ["Tidsadverb", "Underordnande konjunktion", "Samordnande konjunktion", "Preposition"],
                correct: 1,
                category: "Konjunktioner"
            },
            // NYA FRÃ…GOR - Prepositioner (5 st)
            {
                question: "I 'Boken ligger pÃ¥ bordet', vad Ã¤r 'pÃ¥'?",
                options: ["Adverb", "Preposition", "Konjunktion", "Adjektiv"],
                correct: 1,
                category: "Prepositioner"
            },
            {
                question: "Vilken preposition visar riktning?",
                options: ["Med", "Genom", "Under", "Hos"],
                correct: 1,
                category: "Prepositioner"
            },
            {
                question: "I 'Vi trÃ¤ffas vid skolan', vad visar 'vid'?",
                options: ["Tid", "Plats", "SÃ¤tt", "Orsak"],
                correct: 1,
                category: "Prepositioner"
            },
            {
                question: "Vilken preposition anvÃ¤nds fÃ¶r tid?",
                options: ["Ã–ver", "Mellan", "Kring", "FrÃ¥n"],
                correct: 1,
                category: "Prepositioner"
            },
            {
                question: "I 'Han kom utan jacka', vad Ã¤r 'utan'?",
                options: ["Adverb", "Konjunktion", "Preposition", "Verb"],
                correct: 2,
                category: "Prepositioner"
            },
            // NYA FRÃ…GOR - Verb (5 st)
            {
                question: "Vad Ã¤r infinitiv av 'sover'?",
                options: ["Att sov", "Att sova", "Att sovit", "Att sovande"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "I 'De har sprungit fort', vilken verbform Ã¤r 'sprungit'?",
                options: ["Infinitiv", "Presens", "Preteritum", "Supinum"],
                correct: 3,
                category: "Verb"
            },
            {
                question: "Vilket verb Ã¤r oregelbundet?",
                options: ["Hoppa", "GÃ¥", "Leka", "Prata"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "Vad Ã¤r preteritum av 'att skriva'?",
                options: ["Skriver", "Skrev", "Skrivit", "Skrivande"],
                correct: 1,
                category: "Verb"
            },
            {
                question: "I 'Hon kommer att sjunga', vilken verbform Ã¤r 'kommer att sjunga'?",
                options: ["Presens", "Preteritum", "Futurum", "Supinum"],
                correct: 2,
                category: "Verb"
            }
        ];

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZrDBsPBz7Ob6MKB1tMOXl-88V6rZbDH8",
            authDomain: "grammatik-quest-multiplayer.firebaseapp.com",
            databaseURL: "https://grammatik-quest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "grammatik-quest-multiplayer",
            storageBucket: "grammatik-quest-multiplayer.firebasestorage.app",
            messagingSenderId: "413718132066",
            appId: "1:413718132066:web:40698d2cc76b29fcc8683b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Party Mode State
        let partyState = {
            active: false,
            isHost: false,
            isSpectator: false,
            partyCode: null,
            myName: null,
            myId: null,
            myScore: 0,
            timeLimit: 120,
            partyRef: null,
            playersRef: null,
            timerInterval: null,
            gameEnded: false
        };

        // Test Mode State
        let testState = {
            active: false,
            questions: [],
            currentIndex: 0,
            answers: [],
            categoryStats: {}
        };

        let gameState = {
            coins: 0,
            score: 0,
            level: 1,
            xp: 0,
            xpNeeded: 10,
            streak: 0,
            currentQuestion: 0,
            answeredCorrectly: 0,
            totalAnswered: 0,
            hints: 3,
            doublePoints: 2,
            shields: 1,
            streakSavers: 0,
            coinBoostRemaining: 0,
            doubleActive: false,
            shieldActive: false,
            questionsPerLevel: 5,
            // Game modes
            gameMode: 'normal', // normal, timed, survival, topic, write, hard
            timeRemaining: 60,
            timerInterval: null,
            lives: 3,
            selectedTopic: null,
            // Statistics
            stats: {
                totalGamesPlayed: 0,
                highScore: 0,
                longestStreak: 0,
                totalCoinsEarned: 0,
                questionsByCategory: {},
                correctByCategory: {},
                bestTimeMode: 0,
                survivalRecord: 0
            },
            // Achievements
            achievements: {
                firstWin: false,
                streak5: false,
                streak10: false,
                level5: false,
                level10: false,
                coins500: false,
                coins1000: false,
                perfectGame: false,
                shopaholic: false,
                centurion: false,
                timeMaster: false,
                survivor: false,
                // NYA ACHIEVEMENTS
                speedster: false,      // Svara pÃ¥ 10 frÃ¥gor under 1 minut
                streak15: false,       // 15 rÃ¤tt i rad
                level15: false,        // NÃ¥ nivÃ¥ 15
                coins2000: false,      // Samla 2000 mynt
                scholar: false,        // AnvÃ¤nd plugglÃ¤get 10 gÃ¥nger
                powerUser: false,      // AnvÃ¤nd alla power-ups i samma spel
                flawless50: false,     // 50 frÃ¥gor utan fel
                questMaster: false,    // Svara pÃ¥ 500 frÃ¥gor totalt
                allTopics: false,      // Svara rÃ¤tt pÃ¥ minst 10 frÃ¥gor per Ã¤mne
                dedication: false      // Spela 7 dagar i rad
            },
            // Theme
            theme: 'light'
        };

        // Load saved progress
        function loadProgress() {
            const saved = localStorage.getItem('grammatikQuestProgress');
            if (saved) {
                const savedState = JSON.parse(saved);
                // Restore persistent data
                gameState.coins = savedState.coins || 0;
                gameState.level = savedState.level || 1;
                gameState.xp = savedState.xp || 0;
                gameState.xpNeeded = savedState.xpNeeded || 10;
                gameState.stats = savedState.stats || gameState.stats;
                gameState.achievements = savedState.achievements || gameState.achievements;
                gameState.theme = savedState.theme || 'light';
                gameState.hints = savedState.hints || 3;
                gameState.doublePoints = savedState.doublePoints || 2;
                gameState.shields = savedState.shields || 1;
                gameState.streakSavers = savedState.streakSavers || 0;
                gameState.totalAnswered = savedState.totalAnswered || 0;
            }
        }

        // Save progress
        function saveProgress() {
            const toSave = {
                coins: gameState.coins,
                level: gameState.level,
                xp: gameState.xp,
                xpNeeded: gameState.xpNeeded,
                stats: gameState.stats,
                achievements: gameState.achievements,
                theme: gameState.theme,
                hints: gameState.hints,
                doublePoints: gameState.doublePoints,
                shields: gameState.shields,
                streakSavers: gameState.streakSavers,
                totalAnswered: gameState.totalAnswered
            };
            localStorage.setItem('grammatikQuestProgress', JSON.stringify(toSave));
        }

        let usedQuestions = [];
        let questionPool = []; // Pool of questions shuffled for better variation

        // 1v1 Mode State
        let vs1v1State = {
            active: false,
            timeLimit: 120,
            timeRemaining: 120,
            timerInterval: null,
            player1: {
                name: 'Spelare 1',
                score: 0,
                currentQuestion: null,
                answered: false
            },
            player2: {
                name: 'Spelare 2',
                score: 0,
                currentQuestion: null,
                answered: false
            }
        };

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Change mode function - make it global
        window.confirmChangeMode = function() {
            sounds.click?.();
            showConfirmDialog(
                'ðŸ”„ Byt SpellÃ¤ge?',
                'Dina poÃ¤ng kommer bli nollstÃ¤llda',
                () => window.returnToMenu(),
                'Byt SpellÃ¤ge'
            );
        }

        function showConfirmDialog(title, message, onConfirm, confirmText = 'BekrÃ¤fta') {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-dialog">
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <div class="confirm-buttons">
                        <button class="confirm-btn cancel-btn" onclick="closeConfirmDialog()">Avbryt</button>
                        <button class="confirm-btn confirm-btn-yes" onclick="confirmDialogAction()">${confirmText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            window.confirmDialogCallback = onConfirm;
        }

        window.closeConfirmDialog = function() {
            const overlay = document.querySelector('.confirm-overlay');
            if (overlay) {
                const dialog = overlay.querySelector('.confirm-dialog');
                dialog.style.animation = 'confirmDialogOut 0.3s ease-in';
                overlay.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        window.confirmDialogAction = function() {
            sounds.click?.();
            if (window.confirmDialogCallback) {
                window.confirmDialogCallback();
            }
            closeConfirmDialog();
        }

        window.returnToMenu = function() {
            // Clear timer if exists
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            // Reset game state
            gameState.score = 0;
            gameState.streak = 0;
            gameState.answeredCorrectly = 0;
            gameState.currentQuestion = 0;
            gameState.totalAnswered = 0;
            gameState.selectedTopic = null;
            
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('game-mode-selector').style.display = 'block';
            
            updateStats();
        }

        // Sound System
        const sounds = {
            enabled: true, // Always on
            correct: null,
            wrong: null,
            levelUp: null,
            achievement: null,
            coin: null,
            buy: null,
            click: null,
            error: null
        };

        // Initialize sounds using Web Audio API
        function initSounds() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            // Create simple beep sounds
            sounds.correct = () => {
                if (!sounds.enabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            };

            sounds.wrong = () => {
                if (!sounds.enabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 200;
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };

            sounds.levelUp = () => {
                if (!sounds.enabled) return;
                [523, 659, 784].forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.3);
                    oscillator.start(audioContext.currentTime + i * 0.1);
                    oscillator.stop(audioContext.currentTime + i * 0.1 + 0.3);
                });
            };

            sounds.achievement = () => {
                if (!sounds.enabled) return;
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.08);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.08 + 0.4);
                    oscillator.start(audioContext.currentTime + i * 0.08);
                    oscillator.stop(audioContext.currentTime + i * 0.08 + 0.4);
                });
            };

            sounds.coin = () => {
                if (!sounds.enabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 1000;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            };

            sounds.buy = () => {
                if (!sounds.enabled) return;
                [400, 600].forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.05 + 0.15);
                    oscillator.start(audioContext.currentTime + i * 0.05);
                    oscillator.stop(audioContext.currentTime + i * 0.05 + 0.15);
                });
            };

            sounds.click = () => {
                if (!sounds.enabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
            };

            sounds.error = () => {
                if (!sounds.enabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 150;
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            };
        }

        // Initialize sounds on first user interaction
        let soundsInitialized = false;
        document.addEventListener('click', () => {
            if (!soundsInitialized) {
                initSounds();
                soundsInitialized = true;
            }
        }, { once: true });

        // Confetti System
        function createConfetti() {
            const confettiCount = 50;
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = Math.random() * 2 + 2 + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        function createParticles(x, y) {
            const particleCount = 15;
            const colors = ['#FFD700', '#FFA500', '#FF6347'];
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function checkAchievements() {
            const newAchievements = [];
            
            // First Win
            if (!gameState.achievements.firstWin && gameState.answeredCorrectly >= 1) {
                gameState.achievements.firstWin = true;
                newAchievements.push({ name: 'ðŸŽ¯ FÃ¶rsta RÃ¤tta', desc: 'Svara rÃ¤tt pÃ¥ din fÃ¶rsta frÃ¥ga!' });
            }
            
            // Streak achievements
            if (!gameState.achievements.streak5 && gameState.streak >= 5) {
                gameState.achievements.streak5 = true;
                newAchievements.push({ name: 'ðŸ”¥ Hetluften!', desc: '5 rÃ¤tt i rad!' });
            }
            if (!gameState.achievements.streak10 && gameState.streak >= 10) {
                gameState.achievements.streak10 = true;
                newAchievements.push({ name: 'ðŸ”¥ Streak Master!', desc: '10 rÃ¤tt i rad!' });
            }
            if (!gameState.achievements.streak15 && gameState.streak >= 15) {
                gameState.achievements.streak15 = true;
                newAchievements.push({ name: 'ðŸ”¥ Streak Legend!', desc: '15 rÃ¤tt i rad!' });
            }
            
            // Level achievements
            if (!gameState.achievements.level5 && gameState.level >= 5) {
                gameState.achievements.level5 = true;
                newAchievements.push({ name: 'â­ NivÃ¥ 5!', desc: 'NÃ¥dde nivÃ¥ 5!' });
            }
            if (!gameState.achievements.level10 && gameState.level >= 10) {
                gameState.achievements.level10 = true;
                newAchievements.push({ name: 'â­ Grammatik Guru!', desc: 'NÃ¥dde nivÃ¥ 10!' });
            }
            if (!gameState.achievements.level15 && gameState.level >= 15) {
                gameState.achievements.level15 = true;
                newAchievements.push({ name: 'â­ Grammatik MÃ¤stare!', desc: 'NÃ¥dde nivÃ¥ 15!' });
            }
            
            // Coin achievements
            if (!gameState.achievements.coins500 && gameState.coins >= 500) {
                gameState.achievements.coins500 = true;
                newAchievements.push({ name: 'ðŸ’° Rik!', desc: 'Samla 500 mynt!' });
            }
            if (!gameState.achievements.coins1000 && gameState.coins >= 1000) {
                gameState.achievements.coins1000 = true;
                newAchievements.push({ name: 'ðŸ’° Mynt MiljonÃ¤r!', desc: 'Samla 1000 mynt!' });
            }
            if (!gameState.achievements.coins2000 && gameState.coins >= 2000) {
                gameState.achievements.coins2000 = true;
                newAchievements.push({ name: 'ðŸ’° Mynt Magnat!', desc: 'Samla 2000 mynt!' });
            }
            
            // Perfect game (20 questions without mistake)
            if (!gameState.achievements.perfectGame && gameState.answeredCorrectly >= 20 && gameState.totalAnswered === gameState.answeredCorrectly) {
                gameState.achievements.perfectGame = true;
                newAchievements.push({ name: 'ðŸ‘‘ Perfektionist!', desc: '20 frÃ¥gor utan fel!' });
            }
            
            // Flawless 50
            if (!gameState.achievements.flawless50 && gameState.answeredCorrectly >= 50 && gameState.totalAnswered === gameState.answeredCorrectly) {
                gameState.achievements.flawless50 = true;
                newAchievements.push({ name: 'ðŸ‘‘ Felfri MÃ¤stare!', desc: '50 frÃ¥gor utan fel!' });
            }
            
            // Centurion (100 questions answered)
            if (!gameState.achievements.centurion && gameState.totalAnswered >= 100) {
                gameState.achievements.centurion = true;
                newAchievements.push({ name: 'ðŸ’¯ Centurion!', desc: 'Svarat pÃ¥ 100 frÃ¥gor!' });
            }
            
            // Quest Master (500 questions)
            if (!gameState.achievements.questMaster && gameState.totalAnswered >= 500) {
                gameState.achievements.questMaster = true;
                newAchievements.push({ name: 'ðŸ’¯ Quest Master!', desc: '500 frÃ¥gor besvarade!' });
            }
            
            // Power User (use all power-ups in same game)
            if (!gameState.achievements.powerUser) {
                // Track if all power-ups have been used (this would need additional tracking)
                // For now, simplified version
            }
            
            // All Topics (10+ correct per topic)
            if (!gameState.achievements.allTopics) {
                const categories = ['Adjektiv', 'Substantiv', 'Adverb', 'Pronomen', 'Konjunktioner', 'Prepositioner', 'Verb'];
                const allTopicsDone = categories.every(cat => 
                    (gameState.stats.correctByCategory[cat] || 0) >= 10
                );
                if (allTopicsDone) {
                    gameState.achievements.allTopics = true;
                    newAchievements.push({ name: 'ðŸ“š Allvetare!', desc: '10+ rÃ¤tt per Ã¤mne!' });
                }
            }
            
            // Show achievement notifications
            newAchievements.forEach((achievement, index) => {
                setTimeout(() => showAchievement(achievement), index * 500);
            });
            
            if (newAchievements.length > 0) {
                saveProgress();
            }
        }
        
        function showAchievement(achievement) {
            sounds.achievement?.();
            const achievementDiv = document.createElement('div');
            achievementDiv.className = 'achievement-popup';
            achievementDiv.innerHTML = `
                <div class="achievement-content">
                    <div class="achievement-title">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                </div>
            `;
            document.body.appendChild(achievementDiv);
            
            setTimeout(() => {
                achievementDiv.style.animation = 'achievementSlideOut 0.5s ease-in forwards';
                setTimeout(() => achievementDiv.remove(), 500);
            }, 3000);
        }

        function shuffleArray(array) {
            let shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getRandomQuestion() {
            // If pool is empty or we've used most of it, create new shuffled pool
            if (questionPool.length < 5) {
                let availableQuestions = questions;
                
                // Filter by topic if in topic mode
                if (gameState.gameMode === 'topic' && gameState.selectedTopic) {
                    availableQuestions = questions.filter(q => q.category === gameState.selectedTopic);
                }
                
                // Shuffle all questions and add to pool
                questionPool = shuffleArray(availableQuestions);
            }
            
            // Take next question from pool
            const question = questionPool.shift();
            return question;
        }

        function loadQuestion() {
            const question = getRandomQuestion();
            gameState.currentQuestionData = question;
            
            document.getElementById('question').textContent = question.question;
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-btn').style.display = 'none';

            // Remove old study hint if it exists
            const oldHint = document.querySelector('.study-hint');
            if (oldHint) oldHint.remove();

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            // WRITE MODE - Text input instead of buttons
            if (gameState.gameMode === 'write') {
                const inputContainer = document.createElement('div');
                inputContainer.className = 'write-answer-container';
                inputContainer.innerHTML = `
                    <input type="text" id="writeAnswer" class="write-answer-input" placeholder="Skriv ditt svar hÃ¤r..." />
                    <button class="submit-answer-btn" onclick="checkWrittenAnswer()">âœ“ Skicka Svar</button>
                `;
                optionsContainer.appendChild(inputContainer);
                
                // Focus input
                setTimeout(() => document.getElementById('writeAnswer').focus(), 100);
                
                // Allow Enter key to submit
                document.getElementById('writeAnswer').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkWrittenAnswer();
                    }
                });
            } else {
                // NORMAL/HARD MODE - Buttons
                let optionsToShow = question.options;
                
                // HARD MODE - Add 2 extra wrong options
                if (gameState.gameMode === 'hard') {
                    const allWrongOptions = question.options.filter((_, idx) => idx !== question.correct);
                    const extraOptions = generateExtraOptions(question.category, 2);
                    optionsToShow = [
                        question.options[question.correct],
                        ...allWrongOptions,
                        ...extraOptions
                    ];
                }
                
                const shuffledOptions = shuffleArray(optionsToShow.map((opt, idx) => ({
                    text: opt, 
                    index: optionsToShow.indexOf(question.options[question.correct]) === idx ? question.correct : -1
                })));

                shuffledOptions.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => checkAnswer(option.index === question.correct ? question.correct : -1, btn);
                    optionsContainer.appendChild(btn);
                });
            }

            // Add study hint below options
            const studyHint = document.createElement('div');
            studyHint.className = 'study-hint';
            studyHint.innerHTML = `ðŸ’¡ Du kan lÃ¤sa om detta i <strong>${question.category}</strong>`;
            studyHint.style.opacity = '0';
            studyHint.style.transform = 'translateY(-15px)';
            optionsContainer.parentElement.appendChild(studyHint);
            
            // Trigger animation after element is in DOM
            setTimeout(() => {
                studyHint.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                studyHint.style.opacity = '1';
                studyHint.style.transform = 'translateY(0)';
            }, 10);
        }

        // Generate extra wrong options for hard mode
        function generateExtraOptions(category, count) {
            const categoryOptions = {
                'Adjektiv': ['Lugn', 'Fri', 'Fin', 'Rund', 'Bred'],
                'Substantiv': ['TrÃ¤d', 'Sten', 'Moln', 'VÃ¤g', 'SjÃ¶'],
                'Adverb': ['Sent', 'Ofta', 'Ibland', 'Kanske', 'Aldrig'],
                'Pronomen': ['NÃ¥gon', 'Ingen', 'Denna', 'Samma', 'Andra'],
                'Konjunktioner': ['FastÃ¤n', 'Trots', 'Ehuru', 'SÃ¥vida', 'Innan'],
                'Prepositioner': ['Bakom', 'FramfÃ¶r', 'Bredvid', 'Inuti', 'UtanfÃ¶r'],
                'Verb': ['GÃ¥', 'Se', 'Ta', 'GÃ¶ra', 'Komma']
            };
            
            const pool = categoryOptions[category] || ['Alternativ 1', 'Alternativ 2'];
            return shuffleArray(pool).slice(0, count);
        }

        // Check written answer with fuzzy matching
        function checkWrittenAnswer() {
            const input = document.getElementById('writeAnswer');
            const userAnswer = input.value.trim().toLowerCase();
            
            if (!userAnswer) {
                input.style.animation = 'shake 0.5s';
                setTimeout(() => input.style.animation = '', 500);
                return;
            }
            
            input.disabled = true;
            document.querySelector('.submit-answer-btn').disabled = true;
            
            const question = gameState.currentQuestionData;
            const correctAnswer = question.options[question.correct].toLowerCase();
            
            // Fuzzy match - check if answer is similar enough
            const similarity = calculateSimilarity(userAnswer, correctAnswer);
            const isCorrect = similarity > 0.7; // 70% similarity threshold
            
            gameState.totalAnswered++;
            
            // Show what user wrote and correct answer
            const feedback = document.getElementById('feedback');
            
            if (isCorrect) {
                sounds.correct?.();
                gameState.streak++;
                gameState.answeredCorrectly++;
                
                input.style.border = '3px solid #4CAF50';
                input.style.background = '#e8f5e9';
                
                let points = 10;
                let coins = 5;
                
                if (gameState.doubleActive) {
                    points *= 2;
                    gameState.doubleActive = false;
                }
                
                if (gameState.coinBoostRemaining > 0) {
                    coins = Math.floor(coins * 1.5);
                    gameState.coinBoostRemaining--;
                }
                
                gameState.score += points;
                gameState.coins += coins;
                gameState.stats.totalCoinsEarned += coins;
                sounds.coin?.();
                
                let feedbackMsg = `âœ… RÃ¤tt! +${points} poÃ¤ng, +${coins} mynt`;
                if (similarity < 0.95) {
                    feedbackMsg += `<br><small>Du skrev: "${userAnswer}" - Exakt svar: "${question.options[question.correct]}"</small>`;
                }
                if (gameState.streak >= 3) {
                    feedbackMsg += `<br><br><div class="streak-badge">ðŸ”¥ ${gameState.streak} i rad!</div>`;
                }
                
                feedback.innerHTML = `<div class="feedback correct">${feedbackMsg}</div>`;
            } else {
                sounds.wrong?.();
                
                input.style.border = '3px solid #f44336';
                input.style.background = '#ffebee';
                
                if (gameState.gameMode === 'survival') {
                    loseLife();
                }
                
                if (gameState.streakSavers > 0) {
                    gameState.streakSavers--;
                    feedback.innerHTML = `<div class="feedback wrong">âŒ Fel svar!<br>ðŸ”¥ Streak Saver anvÃ¤nde! Din streak fortsÃ¤tter!<br><small>Du skrev: "${userAnswer}" - RÃ¤tt svar: "${question.options[question.correct]}"</small></div>`;
                } else {
                    gameState.streak = 0;
                    feedback.innerHTML = `<div class="feedback wrong">âŒ Fel svar!<br>RÃ¤tt svar Ã¤r: <strong>${question.options[question.correct]}</strong><br><small>Du skrev: "${userAnswer}"</small></div>`;
                }
            }
            
            // Update stats
            gameState.stats.questionsByCategory[question.category] = (gameState.stats.questionsByCategory[question.category] || 0) + 1;
            // Update stats with XP
            if (isCorrect) {
                gameState.xp++;
                
                // Level up when XP reaches needed amount
                if (gameState.xp >= gameState.xpNeeded) {
                    gameState.xp = 0;
                    gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.2);
                    gameState.level++;
                    showLevelUp();
                }
                gameState.stats.correctByCategory[question.category] = (gameState.stats.correctByCategory[question.category] || 0) + 1;
            }
            
            if (gameState.score > gameState.stats.highScore) {
                gameState.stats.highScore = gameState.score;
            }
            if (gameState.streak > gameState.stats.longestStreak) {
                gameState.stats.longestStreak = gameState.streak;
            }
            
            checkAchievements();
            updateStats();
            saveProgress();
            
            document.getElementById('next-btn').style.display = 'block';
            
            gameState.currentQuestion++;
        }

        // Calculate similarity between two strings (Levenshtein-like)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            // Simple similarity: check how many characters match
            let matches = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (longer.includes(shorter[i])) matches++;
            }
            
            return matches / longer.length;
        }

        function checkAnswer(selected, btn) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            const question = gameState.currentQuestionData;
            const isCorrect = selected === question.correct;
            
            gameState.totalAnswered++;

            // Track stats by category
            if (!gameState.stats.questionsByCategory[question.category]) {
                gameState.stats.questionsByCategory[question.category] = 0;
                gameState.stats.correctByCategory[question.category] = 0;
            }
            gameState.stats.questionsByCategory[question.category]++;

            if (isCorrect) {
                btn.classList.add('correct');
                sounds.correct?.();
                gameState.streak++;
                gameState.answeredCorrectly++;
                gameState.stats.correctByCategory[question.category]++;
                
                // Update longest streak
                if (gameState.streak > gameState.stats.longestStreak) {
                    gameState.stats.longestStreak = gameState.streak;
                }
                
                let points = 100;
                let coins = 10;
                
                // Apply coin boost if active
                if (gameState.coinBoostRemaining > 0) {
                    coins = Math.floor(coins * 1.5);
                    gameState.coinBoostRemaining--;
                }
                
                if (gameState.doubleActive) {
                    points *= 2;
                    coins *= 2;
                    gameState.doubleActive = false;
                }

                // Streak bonus
                if (gameState.streak >= 3) {
                    const streakBonus = Math.floor(gameState.streak / 3) * 50;
                    points += streakBonus;
                    coins += Math.floor(streakBonus / 10);
                }

                gameState.score += points;
                gameState.coins += coins;
                gameState.stats.totalCoinsEarned += coins;
                sounds.coin?.();
                
                // Update high score
                if (gameState.score > gameState.stats.highScore) {
                    gameState.stats.highScore = gameState.score;
                }

                // Add smooth shimmer effect instead of coin animation
                showShimmerEffect();

                let feedbackMsg = `âœ… RÃ¤tt svar! +${points} poÃ¤ng, +${coins} mynt`;
                if (gameState.coinBoostRemaining > 0) {
                    feedbackMsg += ` ðŸ’°(${gameState.coinBoostRemaining} boosted frÃ¥gor kvar)`;
                }
                if (gameState.streak >= 3) {
                    feedbackMsg += `<br><br><div class="streak-badge">ðŸ”¥ ${gameState.streak} i rad!</div>`;
                }

                document.getElementById('feedback').innerHTML = `
                    <div class="feedback correct">
                        ${feedbackMsg}
                    </div>
                `;

                // XP and Level up system
                gameState.xp++;
                
                if (gameState.xp >= gameState.xpNeeded) {
                    gameState.xp = 0;
                    gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.2);
                    gameState.level++;
                    showLevelUp();
                }
                
                // Check achievements
                checkAchievements();
            } else {
                if (gameState.shieldActive) {
                    gameState.shieldActive = false;
                    btn.classList.add('correct');
                    document.getElementById('feedback').innerHTML = `
                        <div class="feedback correct">
                            ðŸ›¡ï¸ SkÃ¶lden skyddade dig! Inget straff denna gÃ¥ng.
                        </div>
                    `;
                } else {
                    btn.classList.add('wrong');
                    sounds.wrong?.();
                    
                    // Lose life in survival mode (only if shield didn't protect)
                    if (gameState.gameMode === 'survival') {
                        loseLife();
                    }
                    
                    // Check if streak saver is active
                    if (gameState.streakSavers > 0) {
                        gameState.streakSavers--;
                        document.getElementById('feedback').innerHTML = `
                            <div class="feedback correct">
                                ðŸ”¥ Streak Saver anvÃ¤nd! Din streak Ã¤r fortfarande ${gameState.streak}!
                            </div>
                        `;
                    } else {
                        gameState.streak = 0;
                    }
                    
                    const correctBtn = Array.from(buttons).find((b, idx) => {
                        return b.textContent === question.options[question.correct];
                    });
                    if (correctBtn) correctBtn.classList.add('correct');

                    if (gameState.streakSavers === 0 || gameState.streak === 0) {
                        document.getElementById('feedback').innerHTML = `
                            <div class="feedback wrong">
                                âŒ Fel svar! RÃ¤tt svar var: ${question.options[question.correct]}
                            </div>
                        `;
                    }
                }
            }

            updateStats();
            saveProgress();
            document.getElementById('next-btn').style.display = 'block';
        }

        function showShimmerEffect() {
            const questionCard = document.querySelector('.question-card');
            const shimmer = document.createElement('div');
            shimmer.className = 'shimmer-effect';
            questionCard.appendChild(shimmer);
            
            setTimeout(() => {
                shimmer.remove();
            }, 1000);
        }

        function showCoinAnimation(amount) {
            const coin = document.createElement('div');
            coin.className = 'coin-animation';
            coin.textContent = `+${amount} ðŸ’°`;
            coin.style.left = '50%';
            coin.style.top = '50%';
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 1000);
        }

        function showLevelUp() {
            sounds.levelUp?.();
            createConfetti();
            const msg = document.getElementById('level-up-message');
            msg.innerHTML = `<div class="level-up">ðŸŽ‰ LEVEL UP! Nu Ã¤r du nivÃ¥ ${gameState.level}! ðŸŽ‰</div>`;
            
            // Fade out after 2.5 seconds
            setTimeout(() => {
                const levelUpDiv = msg.querySelector('.level-up');
                if (levelUpDiv) {
                    levelUpDiv.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    levelUpDiv.style.opacity = '0';
                    levelUpDiv.style.transform = 'translateY(-20px) scale(0.9)';
                }
                setTimeout(() => msg.innerHTML = '', 500);
            }, 2500);
        }

        function updateStats() {
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('hint-count').textContent = gameState.hints;
            document.getElementById('double-count').textContent = gameState.doublePoints;
            document.getElementById('shield-count').textContent = gameState.shields;

            // Update XP bar
            document.getElementById('xp-current').textContent = gameState.xp;
            document.getElementById('xp-needed').textContent = gameState.xpNeeded;
            const xpPercent = (gameState.xp / gameState.xpNeeded) * 100;
            document.getElementById('xp-bar-fill').style.width = xpPercent + '%';

            document.getElementById('hint-btn').disabled = gameState.hints === 0;
            document.getElementById('double-btn').disabled = gameState.doublePoints === 0;
            document.getElementById('shield-btn').disabled = gameState.shields === 0;
        }

        function nextQuestion() {
            gameState.currentQuestion++;
            loadQuestion();
        }

        function useHint() {
            if (gameState.hints === 0) return;
            
            gameState.hints--;
            
            // Check if we're in write mode
            if (gameState.gameMode === 'write') {
                const question = gameState.currentQuestionData;
                const correctAnswer = question.options[question.correct];
                const input = document.querySelector('.write-answer-input');
                
                if (!input) return;
                
                // Calculate how many letters to show (2 more each time)
                const currentLength = input.placeholder.length;
                const lettersToShow = Math.min(currentLength + 2, correctAnswer.length);
                
                // Show first N letters as placeholder
                input.placeholder = correctAnswer.substring(0, lettersToShow) + '...';
                
                // Show feedback
                const feedback = document.getElementById('feedback');
                if (feedback) {
                    feedback.innerHTML = `<div class="feedback correct">ðŸ’¡ Hint: ${correctAnswer.substring(0, lettersToShow)}...</div>`;
                    setTimeout(() => {
                        if (feedback.innerHTML.includes('Hint:')) {
                            feedback.innerHTML = '';
                        }
                    }, 3000);
                }
            } else {
                // Normal mode - remove wrong options
                const buttons = document.querySelectorAll('.option-btn:not(.correct):not(.wrong)');
                const question = gameState.currentQuestionData;
                
                let wrongButtons = Array.from(buttons).filter((btn) => {
                    return btn.textContent !== question.options[question.correct];
                });

                if (wrongButtons.length >= 2) {
                    for (let i = 0; i < 2; i++) {
                        const randomIndex = Math.floor(Math.random() * wrongButtons.length);
                        wrongButtons[randomIndex].style.opacity = '0.3';
                        wrongButtons[randomIndex].disabled = true;
                        wrongButtons.splice(randomIndex, 1);
                    }
                }
            }

            updateStats();
        }

        function useDoublePoints() {
            if (gameState.doublePoints === 0) return;
            
            gameState.doublePoints--;
            gameState.doubleActive = true;
            
            const btn = document.getElementById('double-btn');
            const countSpan = document.getElementById('double-count');
            
            if (countSpan) {
                countSpan.textContent = gameState.doublePoints;
            }
            
            // Show activation message with animation
            const feedback = document.getElementById('feedback');
            if (feedback && feedback.innerHTML === '') {
                feedback.innerHTML = '<div class="feedback correct">âš¡ DubbelpoÃ¤ng aktiverad fÃ¶r nÃ¤sta frÃ¥ga!</div>';
                feedback.style.opacity = '1';
                feedback.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    if (feedback.innerHTML.includes('DubbelpoÃ¤ng aktiverad')) {
                        // Smooth fade and collapse out
                        const feedbackDiv = feedback.querySelector('.feedback');
                        if (feedbackDiv) {
                            feedbackDiv.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out, max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out';
                            feedbackDiv.style.opacity = '0';
                            feedbackDiv.style.transform = 'translateY(-15px)';
                            feedbackDiv.style.maxHeight = '0';
                            feedbackDiv.style.paddingTop = '0';
                            feedbackDiv.style.paddingBottom = '0';
                            feedbackDiv.style.marginTop = '0';
                        }
                        
                        setTimeout(() => {
                            feedback.innerHTML = '';
                            feedback.style.transition = '';
                            feedback.style.opacity = '1';
                            feedback.style.transform = 'translateY(0)';
                        }, 400);
                    }
                }, 2000);
            }
            
            updateStats();
        }

        function useShield() {
            if (gameState.shields === 0) return;
            
            gameState.shields--;
            gameState.shieldActive = true;
            
            const btn = document.getElementById('shield-btn');
            const countSpan = document.getElementById('shield-count');
            
            if (countSpan) {
                countSpan.textContent = gameState.shields;
            }
            
            // Show activation message with animation
            const feedback = document.getElementById('feedback');
            if (feedback && feedback.innerHTML === '') {
                feedback.innerHTML = '<div class="feedback correct">ðŸ›¡ï¸ SkÃ¶ld aktiverad! Du Ã¤r skyddad frÃ¥n nÃ¤sta fel.</div>';
                feedback.style.opacity = '1';
                feedback.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    if (feedback.innerHTML.includes('SkÃ¶ld aktiverad')) {
                        // Smooth fade and collapse out
                        const feedbackDiv = feedback.querySelector('.feedback');
                        if (feedbackDiv) {
                            feedbackDiv.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out, max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out';
                            feedbackDiv.style.opacity = '0';
                            feedbackDiv.style.transform = 'translateY(-15px)';
                            feedbackDiv.style.maxHeight = '0';
                            feedbackDiv.style.paddingTop = '0';
                            feedbackDiv.style.paddingBottom = '0';
                            feedbackDiv.style.marginTop = '0';
                        }
                        
                        setTimeout(() => {
                            feedback.innerHTML = '';
                            feedback.style.transition = '';
                            feedback.style.opacity = '1';
                            feedback.style.transform = 'translateY(0)';
                        }, 400);
                    }
                }, 2000);
            }
            
            updateStats();
        }

        function buyItem(type) {
            const prices = {
                hint: 50,
                double: 75,
                shield: 100,
                points: 150,
                streaksaver: 200,
                coinboost: 175
            };

            if (gameState.coins < prices[type]) {
                sounds.error?.();
                // Show "not enough coins" effect
                const shopItem = event.target.closest('.shop-item');
                if (shopItem) {
                    shopItem.style.animation = 'shake 0.5s';
                    setTimeout(() => shopItem.style.animation = '', 500);
                }
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'buy-error-msg';
                errorMsg.textContent = 'âŒ Inte tillrÃ¤ckligt med mynt!';
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 2000);
                return;
            }

            sounds.buy?.();
            gameState.coins -= prices[type];

            // Show success effect
            const shopItem = event.target.closest('.shop-item');
            if (shopItem) {
                shopItem.style.animation = 'buySuccess 0.6s';
                setTimeout(() => shopItem.style.animation = '', 600);
            }

            switch(type) {
                case 'hint':
                    gameState.hints += 3;
                    break;
                case 'double':
                    gameState.doublePoints += 2;
                    break;
                case 'shield':
                    gameState.shields += 2;
                    break;
                case 'points':
                    gameState.score += 500;
                    break;
                case 'streaksaver':
                    gameState.streakSavers += 1;
                    showBuyMessage('ðŸ”¥ Streak Saver kÃ¶pt!');
                    break;
                case 'coinboost':
                    gameState.coinBoostRemaining += 5;
                    showBuyMessage('ðŸ’° Mynt Magnet aktiverad!');
                    break;
            }

            // Check shopaholic achievement (bought 10 items total)
            if (!gameState.achievements.shopaholic) {
                gameState.stats.itemsBought = (gameState.stats.itemsBought || 0) + 1;
                if (gameState.stats.itemsBought >= 10) {
                    gameState.achievements.shopaholic = true;
                    showAchievement({ name: 'ðŸ›’ Shopaholic!', desc: 'KÃ¶pt 10 items frÃ¥n shoppen!' });
                }
            }

            updateStats();
            saveProgress();
        }

        function showBuyMessage(message) {
            const msg = document.createElement('div');
            msg.className = 'buy-success-msg';
            msg.textContent = message;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.transform = 'translateY(-30px)';
            }, 1500);
            setTimeout(() => msg.remove(), 2000);
        }

        // Study Modal Functions
        function openStudyModal() {
            sounds.click?.();
            document.getElementById('studyModal').style.display = 'block';
            showTopic('adjektiv'); // Show first topic by default
        }

        function closeStudyModal() {
            const modal = document.getElementById('studyModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Animate out
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in forwards';
            modal.style.animation = 'modalBackdropFadeOut 0.3s ease-out forwards';
            
            setTimeout(() => {
                modal.style.display = 'none';
                // Reset animations for next open
                modalContent.style.animation = '';
                modal.style.animation = '';
            }, 300);
        }

        function showTopic(topic) {
            // Clear search when switching topics
            const searchInput = document.getElementById('studySearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Update button states
            const buttons = document.querySelectorAll('.topic-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Load content with smooth slide animation
            const contentArea = document.getElementById('studyContentArea');
            
            // Fade out quickly
            contentArea.style.opacity = '0';
            contentArea.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                contentArea.innerHTML = studyMaterials[topic];
                contentArea.scrollTop = 0;
                // Fade in from right
                contentArea.style.opacity = '1';
                contentArea.style.transform = 'translateX(0)';
            }, 150);
        }

        function searchStudyContent() {
            const searchTerm = document.getElementById('studySearchInput').value.toLowerCase();
            const contentArea = document.getElementById('studyContentArea');
            const activeBtn = document.querySelector('.topic-btn.active');
            
            if (!activeBtn) return;
            
            const topic = activeBtn.textContent.toLowerCase();
            const originalContent = studyMaterials[topic];
            
            if (!searchTerm) {
                contentArea.innerHTML = originalContent;
                return;
            }
            
            // Create a temporary div to work with the content
            const temp = document.createElement('div');
            temp.innerHTML = originalContent;
            
            // Highlight matching text
            const walker = document.createTreeWalker(
                temp,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const nodesToReplace = [];
            let node;
            
            while (node = walker.nextNode()) {
                if (node.textContent.toLowerCase().includes(searchTerm)) {
                    nodesToReplace.push(node);
                }
            }
            
            nodesToReplace.forEach(node => {
                const parent = node.parentNode;
                const text = node.textContent;
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                const newHTML = text.replace(regex, '<span class="highlight">$1</span>');
                
                const span = document.createElement('span');
                span.innerHTML = newHTML;
                parent.replaceChild(span, node);
            });
            
            contentArea.innerHTML = temp.innerHTML;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('studyModal');
            if (event.target == modal) {
                closeStudyModal();
            }
        }

        // Start game
        loadQuestion();
        updateStats();

        // Stats Modal Functions
        function openStatsModal() {
            sounds.click?.();
            document.getElementById('statsModal').style.display = 'block';
            updateStatsDisplay();
        }

        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in forwards';
            modal.style.animation = 'modalBackdropFadeOut 0.3s ease-out forwards';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContent.style.animation = '';
                modal.style.animation = '';
            }, 300);
        }

        function updateStatsDisplay() {
            document.getElementById('statHighScore').textContent = gameState.stats.highScore;
            document.getElementById('statLongestStreak').textContent = gameState.stats.longestStreak;
            document.getElementById('statTotalCoins').textContent = gameState.stats.totalCoinsEarned;
            document.getElementById('statTotalQuestions').textContent = gameState.totalAnswered;
            document.getElementById('statHighestLevel').textContent = gameState.level;

            // Display achievements
            const achievementsData = [
                { id: 'firstWin', icon: 'ðŸŽ¯', name: 'FÃ¶rsta RÃ¤tta', desc: 'Svara rÃ¤tt pÃ¥ din fÃ¶rsta frÃ¥ga!' },
                { id: 'streak5', icon: 'ðŸ”¥', name: 'Hetluften!', desc: '5 rÃ¤tt i rad!' },
                { id: 'streak10', icon: 'ðŸ”¥', name: 'Streak Master!', desc: '10 rÃ¤tt i rad!' },
                { id: 'streak15', icon: 'ðŸ”¥', name: 'Streak Legend!', desc: '15 rÃ¤tt i rad!' },
                { id: 'level5', icon: 'â­', name: 'NivÃ¥ 5!', desc: 'NÃ¥dde nivÃ¥ 5!' },
                { id: 'level10', icon: 'â­', name: 'Grammatik Guru!', desc: 'NÃ¥dde nivÃ¥ 10!' },
                { id: 'level15', icon: 'â­', name: 'Grammatik MÃ¤stare!', desc: 'NÃ¥dde nivÃ¥ 15!' },
                { id: 'coins500', icon: 'ðŸ’°', name: 'Rik!', desc: 'Samla 500 mynt!' },
                { id: 'coins1000', icon: 'ðŸ’°', name: 'Mynt MiljonÃ¤r!', desc: 'Samla 1000 mynt!' },
                { id: 'coins2000', icon: 'ðŸ’°', name: 'Mynt Magnat!', desc: 'Samla 2000 mynt!' },
                { id: 'perfectGame', icon: 'ðŸ‘‘', name: 'Perfektionist!', desc: '20 frÃ¥gor utan fel!' },
                { id: 'flawless50', icon: 'ðŸ‘‘', name: 'Felfri MÃ¤stare!', desc: '50 frÃ¥gor utan fel!' },
                { id: 'shopaholic', icon: 'ðŸ›’', name: 'Shopaholic!', desc: 'KÃ¶pt 10 items!' },
                { id: 'centurion', icon: 'ðŸ’¯', name: 'Centurion!', desc: '100 frÃ¥gor besvarade!' },
                { id: 'questMaster', icon: 'ðŸ’¯', name: 'Quest Master!', desc: '500 frÃ¥gor besvarade!' },
                { id: 'timeMaster', icon: 'âš¡', name: 'Time Master!', desc: '20+ frÃ¥gor pÃ¥ 60 sekunder!' },
                { id: 'speedster', icon: 'âš¡', name: 'Speedster!', desc: '10 frÃ¥gor under 1 minut!' },
                { id: 'survivor', icon: 'ðŸ†', name: 'Survivor!', desc: '50+ frÃ¥gor i survival mode!' },
                { id: 'powerUser', icon: 'ðŸŽ®', name: 'Power User!', desc: 'AnvÃ¤nd alla power-ups i samma spel!' },
                { id: 'allTopics', icon: 'ðŸ“š', name: 'Allvetare!', desc: '10+ rÃ¤tt per Ã¤mne!' }
            ];

            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            achievementsData.forEach(ach => {
                const unlocked = gameState.achievements[ach.id];
                const card = document.createElement('div');
                card.className = `achievement-card ${unlocked ? 'unlocked' : 'locked'}`;
                card.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-name">${ach.name}</div>
                    <div class="achievement-desc">${ach.desc}</div>
                    ${unlocked ? '<div style="color: #FFD700; font-weight: bold; margin-top: 10px;">âœ“ UPPLÃ…ST</div>' : '<div style="color: #999; margin-top: 10px;">ðŸ”’ LÃ¥st</div>'}
                `;
                grid.appendChild(card);
            });
        }

        // Initialize game
        loadProgress();
        updateStats(); // Show loaded stats immediately
        // Don't auto-start, show mode selector instead

        // Game Mode Functions
        function startGameMode(mode) {
            sounds.click?.();
            gameState.gameMode = mode;
            gameState.score = 0;
            gameState.streak = 0;
            gameState.answeredCorrectly = 0;
            gameState.totalAnswered = 0;
            
            document.getElementById('game-mode-selector').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            
            // Show powerups and shop for normal modes
            document.getElementById('powerups-section').style.display = 'flex';
            document.getElementById('shop-section').style.display = 'block';
            
            // Setup mode-specific UI
            const infoBar = document.getElementById('game-mode-info');
            infoBar.innerHTML = '';
            
            if (mode === 'timed') {
                gameState.timeRemaining = 60;
                infoBar.innerHTML = `
                    <div class="mode-info-item">
                        <span class="mode-info-icon">â±ï¸</span>
                        <span>Tid: <span id="timer">${gameState.timeRemaining}</span>s</span>
                    </div>
                `;
                startTimer();
            } else if (mode === 'survival') {
                gameState.lives = 3;
                infoBar.innerHTML = `
                    <div class="mode-info-item">
                        <div id="lives-container" class="lives-container">
                            <span class="heart">â¤ï¸</span>
                            <span class="heart">â¤ï¸</span>
                            <span class="heart">â¤ï¸</span>
                        </div>
                    </div>
                `;
            } else if (mode === 'normal') {
                infoBar.innerHTML = `
                    <div class="mode-info-item">
                        <span class="mode-info-icon">ðŸ“</span>
                        <span>Normal Mode</span>
                    </div>
                `;
            } else if (mode === 'write') {
                infoBar.innerHTML = `
                    <div class="mode-info-item">
                        <span class="mode-info-icon">âœï¸</span>
                        <span>Skriv Svar Mode</span>
                    </div>
                `;
            } else if (mode === 'hard') {
                infoBar.innerHTML = `
                    <div class="mode-info-item">
                        <span class="mode-info-icon">ðŸ”¥</span>
                        <span>SvÃ¥r Mode (6 alternativ)</span>
                    </div>
                `;
            } else if (mode === 'test') {
                startTestMode();
                return;
            }
            
            loadQuestion();
            updateStats();
        }

        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = gameState.timeRemaining;
                    if (gameState.timeRemaining <= 10) {
                        timerEl.classList.add('warning');
                    }
                }
                
                if (gameState.timeRemaining <= 0) {
                    endTimedMode();
                }
            }, 1000);
        }

        function endTimedMode() {
            clearInterval(gameState.timerInterval);
            const finalScore = gameState.score;
            const questionsAnswered = gameState.totalAnswered;
            
            // Check for high score
            if (finalScore > gameState.stats.bestTimeMode) {
                gameState.stats.bestTimeMode = finalScore;
            }
            
            // Check achievement
            if (!gameState.achievements.timeMaster && questionsAnswered >= 20) {
                gameState.achievements.timeMaster = true;
                showAchievement({ name: 'âš¡ Time Master!', desc: '20+ frÃ¥gor pÃ¥ 60 sekunder!' });
            }
            
            saveProgress();
            createConfetti();
            
            showResultsModal({
                mode: 'TidslÃ¤ge',
                score: finalScore,
                questions: questionsAnswered,
                correct: gameState.answeredCorrectly,
                isRecord: finalScore > gameState.stats.bestTimeMode - finalScore
            });
        }

        function loseLife() {
            gameState.lives--;
            const container = document.getElementById('lives-container');
            if (container) {
                const hearts = container.querySelectorAll('.heart');
                const heartToRemove = hearts[gameState.lives]; // Get the heart to remove
                if (heartToRemove) {
                    heartToRemove.classList.add('heart-lost');
                    setTimeout(() => heartToRemove.remove(), 600);
                }
            }
            
            if (gameState.lives <= 0) {
                endSurvivalMode();
            }
        }

        function endSurvivalMode() {
            const questionsAnswered = gameState.totalAnswered;
            
            // Check for record
            if (questionsAnswered > gameState.stats.survivalRecord) {
                gameState.stats.survivalRecord = questionsAnswered;
            }
            
            // Check achievement
            if (!gameState.achievements.survivor && questionsAnswered >= 50) {
                gameState.achievements.survivor = true;
                showAchievement({ name: 'ðŸ† Survivor!', desc: '50+ frÃ¥gor i survival mode!' });
            }
            
            saveProgress();
            
            showResultsModal({
                mode: 'Survival',
                score: gameState.score,
                questions: questionsAnswered,
                correct: gameState.answeredCorrectly,
                isRecord: questionsAnswered > gameState.stats.survivalRecord - questionsAnswered
            });
        }

        // Topic Selection
        function openTopicSelector() {
            document.getElementById('topicModal').style.display = 'block';
        }

        function closeTopicModal() {
            const modal = document.getElementById('topicModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in forwards';
            modal.style.animation = 'modalBackdropFadeOut 0.3s ease-out forwards';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContent.style.animation = '';
                modal.style.animation = '';
            }, 300);
        }

        function startTopicMode(topic) {
            gameState.selectedTopic = topic;
            gameState.gameMode = 'topic';
            closeTopicModal();
            
            document.getElementById('game-mode-selector').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            
            const infoBar = document.getElementById('game-mode-info');
            infoBar.innerHTML = `
                <div class="mode-info-item">
                    <span class="mode-info-icon">ðŸ“–</span>
                    <span>Ã„mne: ${topic}</span>
                </div>
            `;
            
            loadQuestion();
            updateStats();
        }

        // Close topic modal when clicking outside
        window.addEventListener('click', function(event) {
            const topicModal = document.getElementById('topicModal');
            if (event.target === topicModal) {
                closeTopicModal();
            }
        });

        // 1v1 Mode Functions
        function open1v1Setup() {
            sounds.click?.();
            document.getElementById('vs1v1SetupModal').style.display = 'block';
        }

        function close1v1Setup() {
            const modal = document.getElementById('vs1v1SetupModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in forwards';
            modal.style.animation = 'modalBackdropFadeOut 0.3s ease-out forwards';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContent.style.animation = '';
                modal.style.animation = '';
            }, 300);
        }

        function start1v1Game() {
            sounds.click?.();
            
            const p1Name = document.getElementById('player1Name').value.trim() || 'Spelare 1';
            const p2Name = document.getElementById('player2Name').value.trim() || 'Spelare 2';
            const timeMinutes = parseInt(document.getElementById('vs1v1TimeInput').value) || 2;
            const timeSeconds = timeMinutes * 60;
            
            vs1v1State = {
                active: true,
                timeLimit: timeSeconds,
                timeRemaining: timeSeconds,
                timerInterval: null,
                player1: { name: p1Name, score: 0, currentQuestion: null, answered: false },
                player2: { name: p2Name, score: 0, currentQuestion: null, answered: false }
            };
            
            close1v1Setup();
            document.querySelector('.game-container').style.display = 'none';
            document.getElementById('vs1v1GameArea').style.display = 'block';
            
            document.getElementById('player1NameDisplay').textContent = p1Name;
            document.getElementById('player2NameDisplay').textContent = p2Name;
            
            // Setup cancel button
            const cancelBtn = document.getElementById('vs1v1CancelBtn');
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    cancel1v1Game();
                };
            }
            
            load1v1Questions();
            start1v1Timer();
        }

        function start1v1Timer() {
            updateTimerDisplay();
            vs1v1State.timerInterval = setInterval(() => {
                vs1v1State.timeRemaining--;
                updateTimerDisplay();
                
                if (vs1v1State.timeRemaining <= 0) {
                    end1v1Game();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(vs1v1State.timeRemaining / 60);
            const seconds = vs1v1State.timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('vs1v1Timer').textContent = display;
            
            if (vs1v1State.timeRemaining <= 10) {
                document.getElementById('vs1v1Timer').style.color = '#ff4444';
            }
        }

        function load1v1Questions() {
            // Load question for player 1
            if (!vs1v1State.player1.answered) {
                const q1 = getRandomQuestion();
                vs1v1State.player1.currentQuestion = q1;
                document.getElementById('player1Question').textContent = q1.question;
                
                const options1 = document.getElementById('player1Options');
                options1.innerHTML = '';
                
                const shuffled1 = shuffleArray(q1.options.map((opt, idx) => ({text: opt, index: idx})));
                shuffled1.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => check1v1Answer(1, option.index, btn);
                    options1.appendChild(btn);
                });
            }
            
            // Load question for player 2
            if (!vs1v1State.player2.answered) {
                const q2 = getRandomQuestion();
                vs1v1State.player2.currentQuestion = q2;
                document.getElementById('player2Question').textContent = q2.question;
                
                const options2 = document.getElementById('player2Options');
                options2.innerHTML = '';
                
                const shuffled2 = shuffleArray(q2.options.map((opt, idx) => ({text: opt, index: idx})));
                shuffled2.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => check1v1Answer(2, option.index, btn);
                    options2.appendChild(btn);
                });
            }
        }

        function check1v1Answer(player, selected, btn) {
            const playerState = player === 1 ? vs1v1State.player1 : vs1v1State.player2;
            const question = playerState.currentQuestion;
            const isCorrect = selected === question.correct;
            
            // Disable all buttons for this player
            const optionsContainer = document.getElementById(`player${player}Options`);
            const buttons = optionsContainer.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);
            
            if (isCorrect) {
                sounds.correct?.();
                btn.classList.add('correct');
                playerState.score++;
                document.getElementById(`player${player}ScoreNum`).textContent = playerState.score;
                document.getElementById(`player${player}Feedback`).innerHTML = `<div class="feedback correct">âœ… RÃ¤tt!</div>`;
            } else {
                sounds.wrong?.();
                btn.classList.add('wrong');
                document.getElementById(`player${player}Feedback`).innerHTML = `<div class="feedback wrong">âŒ Fel!</div>`;
            }
            
            playerState.answered = true;
            
            // Load next question after short delay - only for this player
            setTimeout(() => {
                document.getElementById(`player${player}Feedback`).innerHTML = '';
                playerState.answered = false;
                
                // Load new question for this player only
                const q = getRandomQuestion();
                playerState.currentQuestion = q;
                document.getElementById(`player${player}Question`).textContent = q.question;
                
                const optionsContainer = document.getElementById(`player${player}Options`);
                optionsContainer.innerHTML = '';
                
                const shuffled = shuffleArray(q.options.map((opt, idx) => ({text: opt, index: idx})));
                shuffled.forEach(option => {
                    const newBtn = document.createElement('button');
                    newBtn.className = 'option-btn';
                    newBtn.textContent = option.text;
                    newBtn.onclick = () => check1v1Answer(player, option.index, newBtn);
                    optionsContainer.appendChild(newBtn);
                });
            }, 1500);
        }

        function end1v1Game() {
            clearInterval(vs1v1State.timerInterval);
            vs1v1State.active = false;
            
            createConfetti();
            sounds.levelUp?.();
            
            const winner = vs1v1State.player1.score > vs1v1State.player2.score ? vs1v1State.player1 
                          : vs1v1State.player2.score > vs1v1State.player1.score ? vs1v1State.player2 
                          : null;
            
            let resultHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 30px;">ðŸ Spelet Slut!</h2>
                    <div style="display: flex; gap: 30px; justify-content: center; margin-bottom: 30px;">
                        <div style="padding: 20px; background: linear-gradient(135deg, #4ecdc4 0%, #44a3a6 100%); border-radius: 15px; color: white; flex: 1; max-width: 250px;">
                            <h3 style="font-size: 1.5em; margin-bottom: 10px;">${vs1v1State.player1.name}</h3>
                            <div style="font-size: 3em; font-weight: bold;">${vs1v1State.player1.score}</div>
                            <div>rÃ¤tt svar</div>
                        </div>
                        <div style="padding: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); border-radius: 15px; color: white; flex: 1; max-width: 250px;">
                            <h3 style="font-size: 1.5em; margin-bottom: 10px;">${vs1v1State.player2.name}</h3>
                            <div style="font-size: 3em; font-weight: bold;">${vs1v1State.player2.score}</div>
                            <div>rÃ¤tt svar</div>
                        </div>
                    </div>
            `;
            
            if (winner) {
                resultHTML += `<div style="font-size: 2em; color: #FFD700; font-weight: bold; margin-bottom: 30px;">ðŸ† ${winner.name} vinner! ðŸ†</div>`;
            } else {
                resultHTML += `<div style="font-size: 2em; color: #667eea; font-weight: bold; margin-bottom: 30px;">ðŸ¤ Oavgjort! ðŸ¤</div>`;
            }
            
            resultHTML += `
                    <button class="results-btn" onclick="return1v1ToMenu()">ðŸ  Tillbaka till Menyn</button>
                </div>
            `;
            
            const modal = document.getElementById('resultsModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div id="results-content">${resultHTML}</div>
                </div>
            `;
            modal.style.display = 'block';
        }

        function return1v1ToMenu() {
            closeResultsModal();
            document.getElementById('vs1v1GameArea').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
        }

        function cancel1v1Game() {
            // Local 1v1 mode
            showConfirmDialog(
                'ðŸ”„ Avbryt Match?',
                'Ã„r du sÃ¤ker pÃ¥ att du vill avbryta matchen?',
                function() {
                    if (vs1v1State.timerInterval) {
                        clearInterval(vs1v1State.timerInterval);
                    }
                    vs1v1State.active = false;
                    document.getElementById('vs1v1GameArea').style.display = 'none';
                    document.querySelector('.game-container').style.display = 'block';
                },
                'Avbryt Match'
            );
        }

        // Make sure function is globally accessible
        window.cancel1v1Game = cancel1v1Game;

        /* ===== TEST MODE FUNCTIONS ===== */

        function startTestMode() {
            sounds.click?.();
            testState.active = true;
            testState.questions = [];
            testState.currentIndex = 0;
            testState.answers = [];
            testState.categoryStats = {};
            
            // Get unique categories
            const categories = [...new Set(questions.map(q => q.category))];
            
            // Get 4 questions from each category
            categories.forEach(category => {
                const categoryQuestions = questions.filter(q => q.category === category);
                const shuffled = shuffleArray([...categoryQuestions]);
                const selected = shuffled.slice(0, 4);
                testState.questions.push(...selected);
                testState.categoryStats[category] = { correct: 0, total: 4 };
            });
            
            // Shuffle all test questions
            testState.questions = shuffleArray(testState.questions);
            
            document.getElementById('game-mode-selector').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            
            // Hide powerups and shop in test mode
            document.getElementById('powerups-section').style.display = 'none';
            document.getElementById('shop-section').style.display = 'none';
            
            const infoBar = document.getElementById('game-mode-info');
            infoBar.innerHTML = `
                <div class="mode-info-item">
                    <span class="mode-info-icon">ðŸ“‹</span>
                    <span>Prov Mode - FrÃ¥ga <span id="testProgress">1/${testState.questions.length}</span></span>
                </div>
            `;
            
            loadTestQuestion();
        }

        function loadTestQuestion() {
            if (testState.currentIndex >= testState.questions.length) {
                endTestMode();
                return;
            }
            
            const q = testState.questions[testState.currentIndex];
            gameState.currentQuestionData = q;
            
            document.getElementById('testProgress').textContent = 
                `${testState.currentIndex + 1}/${testState.questions.length}`;
            
            document.getElementById('question').textContent = q.question;
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-btn').style.display = 'none';
            
            const container = document.getElementById('options');
            container.innerHTML = '';
            
            const shuffled = shuffleArray(q.options.map((opt, idx) => ({text: opt, index: idx})));
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.onclick = () => checkTestAnswer(option.index, btn);
                container.appendChild(btn);
            });
        }

        function checkTestAnswer(selected, btn) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);
            
            const question = gameState.currentQuestionData;
            const isCorrect = selected === question.correct;
            
            // Store answer but DON'T show if it's correct or wrong
            testState.answers.push({
                question: question,
                selected: selected,
                correct: isCorrect
            });
            
            // Update category stats
            if (isCorrect) {
                testState.categoryStats[question.category].correct++;
            }
            
            // Just mark which option was selected
            btn.style.background = 'linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%)';
            btn.style.color = 'white';
            
            // Show neutral feedback
            document.getElementById('feedback').innerHTML = 
                '<div class="feedback">âœ“ Svar registrerat</div>';
            
            testState.currentIndex++;
            
            // Auto-advance after 1 second
            setTimeout(() => {
                loadTestQuestion();
            }, 1000);
        }

        function endTestMode() {
            testState.active = false;
            
            const totalQuestions = testState.questions.length;
            const correctAnswers = testState.answers.filter(a => a.correct).length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Calculate category performance
            const categoryResults = Object.entries(testState.categoryStats)
                .map(([category, stats]) => ({
                    category,
                    correct: stats.correct,
                    total: stats.total,
                    percentage: Math.round((stats.correct / stats.total) * 100)
                }))
                .sort((a, b) => a.percentage - b.percentage);
            
            // Find strengths and weaknesses
            const weakest = categoryResults.slice(0, 2);
            const strongest = categoryResults.slice(-2).reverse();
            
            sounds.levelUp?.();
            createConfetti();
            
            let resultHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 20px;">ðŸ“‹ Provresultat</h2>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; margin-bottom: 30px;">
                        <div style="font-size: 4em; font-weight: bold; margin-bottom: 10px;">${percentage}%</div>
                        <div style="font-size: 1.5em;">${correctAnswers} av ${totalQuestions} rÃ¤tt</div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 3px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 15px;">âš ï¸ Ã–va mer pÃ¥:</h3>
            `;
            
            weakest.forEach(cat => {
                resultHTML += `
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="font-size: 1.3em; font-weight: bold; color: #dc3545;">${cat.category}</div>
                        <div style="font-size: 1.1em; color: #666;">${cat.correct}/${cat.total} rÃ¤tt (${cat.percentage}%)</div>
                    </div>
                `;
            });
            
            resultHTML += `
                    </div>
                    
                    <div style="background: #d4edda; padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 3px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 15px;">âœ… Bra pÃ¥:</h3>
            `;
            
            strongest.forEach(cat => {
                resultHTML += `
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="font-size: 1.3em; font-weight: bold; color: #28a745;">${cat.category}</div>
                        <div style="font-size: 1.1em; color: #666;">${cat.correct}/${cat.total} rÃ¤tt (${cat.percentage}%)</div>
                    </div>
                `;
            });
            
            resultHTML += `
                    </div>
                    
                    <button class="results-btn" onclick="closeResultsModal()">ðŸ  Tillbaka till Menyn</button>
                </div>
            `;
            
            const modal = document.getElementById('resultsModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div id="results-content">${resultHTML}</div>
                </div>
            `;
            modal.style.display = 'block';
        }

        /* ===== PARTY MODE FUNCTIONS ===== */

        let isSpectatorMode = false;

        function selectSpectatorMode(spectator) {
            isSpectatorMode = spectator;
            document.querySelectorAll('.spectator-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function openPartySetup() {
            sounds.click?.();
            document.getElementById('partySetupModal').style.display = 'block';
        }

        function closePartySetup() {
            document.getElementById('partySetupModal').style.display = 'none';
            document.getElementById('partyLobby').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'none';
        }

        function switchPartyTab(tab) {
            const tabs = document.querySelectorAll('.party-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'host') {
                tabs[0].classList.add('active');
                document.getElementById('hostTab').style.display = 'block';
                document.getElementById('joinTab').style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('hostTab').style.display = 'none';
                document.getElementById('joinTab').style.display = 'block';
            }
        }

        function generatePartyCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function createParty() {
            const hostName = document.getElementById('partyHostName').value.trim() || 'Host';
            const partyCode = generatePartyCode();
            const timeMinutes = parseInt(document.getElementById('partyTimeInput').value) || 2;
            const timeSeconds = timeMinutes * 60;
            
            partyState.partyCode = partyCode;
            partyState.myName = hostName;
            partyState.myId = 'host_' + Date.now();
            partyState.isHost = true;
            partyState.timeLimit = timeSeconds;
            partyState.isSpectator = isSpectatorMode;
            
            try {
                const partyRef = db.collection('parties').doc(partyCode);
                partyState.partyRef = partyRef;
                partyState.playersRef = partyRef.collection('players');
                
                await partyRef.set({
                    host: hostName,
                    timeLimit: timeSeconds,
                    timeRemaining: timeSeconds,
                    status: 'waiting',
                    gameStarted: false,
                    gameEnded: false,
                    currentQuestion: null,
                    createdAt: Date.now()
                });
                
                // Only add to players if not spectator
                if (!isSpectatorMode) {
                    await partyState.playersRef.doc(partyState.myId).set({
                        name: hostName,
                        score: 0,
                        isHost: true
                    });
                }
                
                document.getElementById('partyCodeDisplay').textContent = partyCode;
                document.getElementById('partyLobby').style.display = 'block';
                
                updatePlayersList();
                
            } catch (error) {
                console.error('Error creating party:', error);
                alert('Kunde inte skapa party!');
            }
        }

        async function joinParty() {
            const playerName = document.getElementById('partyJoinName').value.trim() || 'Spelare';
            const partyCode = document.getElementById('joinPartyCode').value.trim();
            
            if (partyCode.length !== 6) {
                alert('Ange giltig 6-siffrig kod!');
                return;
            }
            
            partyState.partyCode = partyCode;
            partyState.myName = playerName;
            partyState.myId = 'player_' + Date.now();
            partyState.isHost = false;
            
            try {
                const partyRef = db.collection('parties').doc(partyCode);
                const snapshot = await partyRef.get();
                
                if (!snapshot.exists) {
                    alert('Party finns inte!');
                    return;
                }
                
                partyState.partyRef = partyRef;
                partyState.playersRef = partyRef.collection('players');
                
                await partyState.playersRef.doc(partyState.myId).set({
                    name: playerName,
                    score: 0,
                    isHost: false
                });
                
                document.getElementById('waitingArea').style.display = 'block';
                
                updateJoinPlayersList();
                
                partyRef.onSnapshot((snap) => {
                    const data = snap.data();
                    if (data && data.gameStarted === true) {
                        startPartyGameplay();
                    }
                });
                
            } catch (error) {
                console.error('Error joining party:', error);
                alert('Kunde inte gÃ¥ med i party!');
            }
        }

        function updatePlayersList() {
            partyState.playersRef.onSnapshot((snapshot) => {
                const list = document.getElementById('playersList');
                list.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const player = doc.data();
                    const div = document.createElement('div');
                    div.className = 'player-item' + (player.isHost ? ' host' : '');
                    div.innerHTML = `${player.isHost ? 'ðŸ‘‘' : 'ðŸŽ®'} ${player.name}`;
                    list.appendChild(div);
                });
            });
        }

        function updateJoinPlayersList() {
            partyState.playersRef.onSnapshot((snapshot) => {
                const list = document.getElementById('joinPlayersList');
                list.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const player = doc.data();
                    const div = document.createElement('div');
                    div.className = 'player-item' + (player.isHost ? ' host' : '');
                    div.innerHTML = `${player.isHost ? 'ðŸ‘‘' : 'ðŸŽ®'} ${player.name}`;
                    list.appendChild(div);
                });
            });
        }

        function copyPartyCode() {
            const code = document.getElementById('partyCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Party kod kopierad! ðŸŽ‰');
            });
        }

        async function startPartyGame() {
            if (!partyState.isHost) return;
            
            await partyState.partyRef.update({
                gameStarted: true,
                timeRemaining: partyState.timeLimit
            });
            
            startPartyGameplay();
        }

        function startPartyGameplay() {
            closePartySetup();
            partyState.active = true;
            partyState.myScore = 0;
            
            document.querySelector('.game-container').style.display = 'none';
            document.getElementById('partyGameArea').style.display = 'block';
            
            const wrapper = document.getElementById('partyGameWrapper');
            
            if (partyState.isSpectator) {
                // Spectator mode - only show leaderboard
                wrapper.classList.add('spectator-mode');
                document.getElementById('partyMyName').textContent = partyState.myName + ' (ObservatÃ¶r)';
            } else {
                // Player mode
                wrapper.classList.remove('spectator-mode');
                document.getElementById('partyMyName').textContent = partyState.myName;
                document.getElementById('partyMyScore').textContent = '0';
            }
            
            showCountdown(() => {
                if (partyState.isHost) {
                    startPartyTimer();
                } else {
                    listenToPartyTimer();
                }
                
                // Everyone (except spectators) loads their own first question
                if (!partyState.isSpectator) {
                    const q = getRandomQuestion();
                    displayPartyQuestion(q);
                }
                
                updateLiveLeaderboard();
            });
        }

        function startPartyTimer() {
            partyState.timerInterval = setInterval(async () => {
                const snapshot = await partyState.partyRef.get();
                const data = snapshot.data();
                
                if (!data || data.gameEnded) {
                    clearInterval(partyState.timerInterval);
                    return;
                }
                
                let time = data.timeRemaining - 1;
                
                if (time <= 0) {
                    clearInterval(partyState.timerInterval);
                    await partyState.partyRef.update({
                        timeRemaining: 0,
                        gameEnded: true
                    });
                    return;
                }
                
                await partyState.partyRef.update({ timeRemaining: time });
            }, 1000);
        }

        function listenToPartyTimer() {
            partyState.partyRef.onSnapshot((snapshot) => {
                const data = snapshot.data();
                if (!data) return;
                
                const time = data.timeRemaining;
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                document.getElementById('partyTimer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (data.gameEnded === true) {
                    endPartyGame();
                }
            });
        }

        function displayPartyQuestion(q) {
            document.getElementById('partyQuestion').textContent = q.question;
            
            const container = document.getElementById('partyOptions');
            container.innerHTML = '';
            
            const shuffled = shuffleArray(q.options.map((opt, idx) => ({text: opt, index: idx})));
            shuffled.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.onclick = () => checkPartyAnswer(option.index === q.correct, btn, q);
                container.appendChild(btn);
            });
        }

        async function checkPartyAnswer(isCorrect, btn, question) {
            const options = document.querySelectorAll('#partyOptions .option-btn');
            options.forEach(b => b.disabled = true);
            
            if (isCorrect) {
                sounds.correct?.();
                btn.classList.add('correct');
                partyState.myScore++;
                
                await partyState.playersRef.doc(partyState.myId).update({
                    score: partyState.myScore
                });
                
                document.getElementById('partyMyScore').textContent = partyState.myScore;
                document.getElementById('partyFeedback').innerHTML = 
                    '<div class="feedback correct">âœ… RÃ¤tt!</div>';
            } else {
                sounds.wrong?.();
                btn.classList.add('wrong');
                document.getElementById('partyFeedback').innerHTML = 
                    '<div class="feedback wrong">âŒ Fel!</div>';
            }
            
            setTimeout(() => {
                document.getElementById('partyFeedback').innerHTML = '';
                
                // EVERYONE generates their own new question!
                const q = getRandomQuestion();
                displayPartyQuestion(q);
            }, 1200);
        }

        function updateLiveLeaderboard() {
            partyState.playersRef.onSnapshot((snapshot) => {
                const players = [];
                snapshot.forEach((doc) => {
                    players.push({...doc.data(), id: doc.id});
                });
                
                const sorted = players.sort((a, b) => b.score - a.score);
                
                const list = document.getElementById('liveLeaderboard');
                list.innerHTML = '';
                
                sorted.forEach((player, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item' + (player.id === partyState.myId ? ' me' : '');
                    
                    let rank = '';
                    if (index === 0) rank = '<span class="leaderboard-rank gold">ðŸ¥‡</span>';
                    else if (index === 1) rank = '<span class="leaderboard-rank silver">ðŸ¥ˆ</span>';
                    else if (index === 2) rank = '<span class="leaderboard-rank bronze">ðŸ¥‰</span>';
                    else rank = `<span class="leaderboard-rank">${index + 1}</span>`;
                    
                    div.innerHTML = `
                        ${rank}
                        <span class="leaderboard-name">${player.name}</span>
                        <span class="leaderboard-score">${player.score}</span>
                    `;
                    list.appendChild(div);
                });
            });
        }

        async function endPartyGame() {
            if (partyState.gameEnded) return;
            partyState.gameEnded = true;
            
            clearInterval(partyState.timerInterval);
            
            const snapshot = await partyState.playersRef.get();
            const players = [];
            snapshot.forEach((doc) => {
                players.push({...doc.data(), id: doc.id});
            });
            const sorted = players.sort((a, b) => b.score - a.score);
            
            createConfetti();
            sounds.levelUp?.();
            
            let resultHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 30px;">ðŸ Party Slut!</h2>
                    <h3 style="font-size: 2em; color: #FFD700; margin-bottom: 30px;">
                        ðŸ† ${sorted[0].name} vinner med ${sorted[0].score} rÃ¤tt!
                    </h3>
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px;">ðŸ“Š Final Leaderboard</h3>
            `;
            
            sorted.forEach((player, index) => {
                let medal = '';
                if (index === 0) medal = 'ðŸ¥‡';
                else if (index === 1) medal = 'ðŸ¥ˆ';
                else if (index === 2) medal = 'ðŸ¥‰';
                else medal = `${index + 1}.`;
                
                resultHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; ${player.id === partyState.myId ? 'border: 3px solid #4ecdc4;' : ''}">
                        <span style="font-size: 1.5em;">${medal} ${player.name}</span>
                        <span style="font-size: 1.5em; font-weight: bold; color: #667eea;">${player.score} rÃ¤tt</span>
                    </div>
                `;
            });
            
            resultHTML += `
                    </div>
                    <button class="results-btn" onclick="returnFromParty()">ðŸ  Tillbaka till Menyn</button>
                </div>
            `;
            
            const modal = document.getElementById('resultsModal');
            modal.innerHTML = `<div class="modal-content"><div id="results-content">${resultHTML}</div></div>`;
            modal.style.display = 'block';
        }

        window.returnFromParty = function() {
            closeResultsModal();
            
            if (partyState.partyRef) {
                if (partyState.isHost) {
                    partyState.partyRef.delete();
                }
            }
            
            partyState = {
                active: false,
                isHost: false,
                isSpectator: false,
                partyCode: null,
                myName: null,
                myId: null,
                myScore: 0,
                timeLimit: 120,
                partyRef: null,
                playersRef: null,
                timerInterval: null,
                gameEnded: false
            };
            
            isSpectatorMode = false;
            
            document.getElementById('partyGameArea').style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
        };

        window.cancelPartyGame = function() {
            showConfirmDialog(
                'ðŸ‘‹ LÃ¤mna Party?',
                'Ã„r du sÃ¤ker pÃ¥ att du vill lÃ¤mna partyt?',
                function() {
                    // Confirmed - leave party
                    clearInterval(partyState.timerInterval);
                    
                    if (partyState.partyRef) {
                        if (!partyState.isSpectator && partyState.playersRef && partyState.myId) {
                            partyState.playersRef.doc(partyState.myId).delete();
                        }
                        if (partyState.isHost) {
                            partyState.partyRef.delete();
                        }
                    }
                    
                    partyState.active = false;
                    document.getElementById('partyGameArea').style.display = 'none';
                    document.querySelector('.game-container').style.display = 'block';
                },
                'LÃ¤mna'
            );
        };

        // Close modals when clicking outside

        function showCountdown(callback) {
            const overlay = document.createElement('div');
            overlay.className = 'countdown-overlay';
            document.body.appendChild(overlay);
            
            let count = 3;
            
            function updateCountdown() {
                if (count > 0) {
                    sounds.click?.();
                    overlay.innerHTML = `<div class="countdown-number">${count}</div>`;
                    count--;
                    setTimeout(updateCountdown, 1000);
                } else {
                    sounds.levelUp?.();
                    overlay.innerHTML = `<div class="countdown-go">KÃ–R!</div>`;
                    createConfetti();
                    setTimeout(() => {
                        overlay.remove();
                        callback();
                    }, 1000);
                }
            }
            
            updateCountdown();
        }

        // OLD ONLINE FUNCTIONS - NOT USED ANYMORE (Party Mode is the new multiplayer)
        /*
        function syncOnlineQuestion() {
            onlineState.gameRef.child('currentQuestion').on('value', (snapshot) => {
                const q = snapshot.val();
                if (!q) return;
                
                document.getElementById('player1Question').textContent = q.question;
                
                const optionsContainer = document.getElementById('player1Options');
                optionsContainer.innerHTML = '';
                
                const shuffled = shuffleArray(q.options.map((opt, idx) => ({text: opt, index: idx})));
                shuffled.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => checkOnlineAnswer(option.index === q.correct, btn);
                    optionsContainer.appendChild(btn);
                });
                
                onlineState.currentQuestion = q;
            });
        }

        function loadNewOnlineQuestion() {
            if (!onlineState.isHost) return;
            
            const q = getRandomQuestion();
            onlineState.gameRef.update({
                currentQuestion: {
                    question: q.question,
                    options: q.options,
                    correct: q.correct,
                    category: q.category
                }
            });
        }
        */

        // Close modals when clicking outside
        window.onclick = function(event) {
            const onlineModal = document.getElementById('onlineSetupModal');
            if (event.target === onlineModal) {
                closeOnlineSetup();
            }
        };

        // Close topic modal when clicking outside
        window.addEventListener('click', function(event) {
            const topicModal = document.getElementById('topicModal');
            if (event.target === topicModal) {
                closeTopicModal();
            }
        });

        // Results Modal Functions
        let currentResults = null;

        function showResultsModal(results) {
            currentResults = results;
            const modal = document.getElementById('resultsModal');
            const content = document.getElementById('results-content');
            
            content.innerHTML = `
                <div class="results-stat">ðŸŽ® ${results.mode}</div>
                <div class="results-stat">â­ PoÃ¤ng: ${results.score}</div>
                <div class="results-stat">ðŸ“ FrÃ¥gor: ${results.questions}</div>
                <div class="results-stat">âœ… RÃ¤tt: ${results.correct}</div>
                ${results.isRecord ? '<div class="results-record">ðŸ† NYTT REKORD! ðŸ†</div>' : ''}
            `;
            
            modal.style.display = 'block';
        }

        function closeResultsModal() {
            const modal = document.getElementById('resultsModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.style.animation = 'modalSlideOut 0.3s ease-in forwards';
            modal.style.animation = 'modalBackdropFadeOut 0.3s ease-out forwards';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContent.style.animation = '';
                modal.style.animation = '';
                
                // Reset game area and return to menu
                document.getElementById('game-area').style.display = 'none';
                document.getElementById('game-mode-selector').style.display = 'block';
                
                // Show powerups and shop again
                document.getElementById('powerups-section').style.display = 'flex';
                document.getElementById('shop-section').style.display = 'block';
                
                // Reset test state if in test mode
                if (testState.active) {
                    testState.active = false;
                    testState.questions = [];
                    testState.currentIndex = 0;
                    testState.answers = [];
                    testState.categoryStats = {};
                }
            }, 300);
        }

        function closeResultsModalAndReturn() {
            closeResultsModal();
            setTimeout(() => returnToMenu(), 300);
        }

        function shareResults() {
            if (!currentResults) return;
            
            const text = `ðŸŽ“ Grammatik Quest - ${currentResults.mode}

â­ PoÃ¤ng: ${currentResults.score}
ðŸ“ FrÃ¥gor: ${currentResults.questions}
âœ… RÃ¤tt: ${currentResults.correct}
${currentResults.isRecord ? 'ðŸ† NYTT REKORD!' : ''}

Kan du slÃ¥ mitt resultat? ðŸŽ®`;

            if (navigator.share) {
                navigator.share({
                    title: 'Grammatik Quest Resultat',
                    text: text
                }).catch(err => {
                    // Fallback to clipboard
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('ðŸ“‹ Resultat kopierat! Klistra in det var du vill! ðŸŽ‰');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('ðŸ“‹ Resultat kopierat! Klistra in det var du vill! ðŸŽ‰');
            });
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        // Service worker registered successfully
                    })
                    .catch(err => {
                        // Service worker not available, app still works fine
                    });
            });
        }

        // Install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after 3 seconds
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwaInstallDismissed')) {
                    showInstallPrompt();
                }
            }, 3000);
        });

        function showInstallPrompt() {
            const installDiv = document.createElement('div');
            installDiv.className = 'install-prompt';
            installDiv.innerHTML = `
                <div class="install-content">
                    <div class="install-icon">ðŸ“±</div>
                    <div class="install-text">
                        <strong>Installera Grammatik Quest!</strong>
                        <p>Spela offline nÃ¤r som helst! ðŸŽ®</p>
                    </div>
                    <button class="install-btn-yes" onclick="installPWA()">Installera</button>
                    <button class="install-btn-no" onclick="dismissInstallPrompt()">Inte nu</button>
                </div>
            `;
            document.body.appendChild(installDiv);
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed!');
                    }
                    deferredPrompt = null;
                    document.querySelector('.install-prompt')?.remove();
                });
            }
        }

        function dismissInstallPrompt() {
            localStorage.setItem('pwaInstallDismissed', 'true');
            document.querySelector('.install-prompt')?.remove();
        }
    </script>
</body>
</html>